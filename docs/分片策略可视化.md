# ES Serverless 分片策略可视化

## 总体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    ES Serverless 平台                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              ShardController（分片控制器）              │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │                                                         │    │
│  │  ┌─────────────────────────────────────────────────┐  │    │
│  │  │  定时监控服务 (每30秒)                          │  │    │
│  │  │  ticker: time.NewTicker(30 * time.Second)       │  │    │
│  │  └─────────────────────────────────────────────────┘  │    │
│  │              ↓                                          │    │
│  │  ┌─────────────────────────────────────────────────┐  │    │
│  │  │  getClusterStats()                              │  │    │
│  │  │  - 获取节点数量                                  │  │    │
│  │  │  - 获取分片总数                                  │  │    │
│  │  │  - 获取分片分布                                  │  │    │
│  │  │  - 获取节点负载                                  │  │    │
│  │  └─────────────────────────────────────────────────┘  │    │
│  │              ↓                                          │    │
│  │  ┌─────────────────────────────────────────────────┐  │    │
│  │  │  manageShards()                                 │  │    │
│  │  │                                                  │  │    │
│  │  │  ┌────────────────────────────────────────┐    │  │    │
│  │  │  │ shouldRebalance(stats)                 │    │  │    │
│  │  │  │ 计算: avgShardsPerNode = 总分片/节点数  │    │  │    │
│  │  │  │ 判断: avgShardsPerNode > 5 ?           │    │  │    │
│  │  │  └────────────────────────────────────────┘    │  │    │
│  │  │              ↓ YES                              │  │    │
│  │  │  ┌────────────────────────────────────────┐    │  │    │
│  │  │  │ rebalanceShards()                      │    │  │    │
│  │  │  │ - 启用重平衡                            │    │  │    │
│  │  │  │ - 设置并发恢复数: 2                     │    │  │    │
│  │  │  │ - 限制恢复速率: 50mb/s                  │    │  │    │
│  │  │  └────────────────────────────────────────┘    │  │    │
│  │  │                                                  │  │    │
│  │  │  ┌────────────────────────────────────────┐    │  │    │
│  │  │  │ hasHotShards(stats)                    │    │  │    │
│  │  │  │ 检测热点分片（高QPS/高负载）            │    │  │    │
│  │  │  └────────────────────────────────────────┘    │  │    │
│  │  │              ↓ YES                              │  │    │
│  │  │  ┌────────────────────────────────────────┐    │  │    │
│  │  │  │ optimizeShardAllocation()              │    │  │    │
│  │  │  │ - 分片级别平衡: 0.45                    │    │  │    │
│  │  │  │ - 索引级别平衡: 0.55                    │    │  │    │
│  │  │  │ - 平衡阈值: 1.0                         │    │  │    │
│  │  │  └────────────────────────────────────────┘    │  │    │
│  │  └─────────────────────────────────────────────────┘  │    │
│  │              ↓                                          │    │
│  │  ┌─────────────────────────────────────────────────┐  │    │
│  │  │  Elasticsearch API 调用                         │  │    │
│  │  │  PUT /_cluster/settings                         │  │    │
│  │  └─────────────────────────────────────────────────┘  │    │
│  │                                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              API 接口层                                 │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │  GET  /shards  → handleGetShardInfo()                  │    │
│  │  POST /shards  → handleManageShards()                  │    │
│  │                  - action: "rebalance"                  │    │
│  │                  - action: "optimize"                   │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 重平衡决策流程

```
┌─────────────────────────────────────────────────────────┐
│ 1. 获取集群状态                                          │
│    GET /_cluster/stats                                   │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 2. 计算关键指标                                          │
│    - 节点数量: nodeCount                                 │
│    - 总分片数: shardCount                                │
│    - 平均分片/节点: avgShardsPerNode                     │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 3. 决策判断                                              │
│    avgShardsPerNode > 5 ?                                │
└─────────┬──────────────┬────────────────────────────────┘
          │ YES          │ NO
          ▼              ▼
┌────────────────┐  ┌──────────────────┐
│ 4a. 触发重平衡  │  │ 4b. 继续监控      │
│                │  │    (30秒后再检查)  │
└────────┬───────┘  └──────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│ 5. 更新集群设置                                          │
│    PUT /_cluster/settings                                │
│    {                                                     │
│      "transient": {                                      │
│        "cluster.routing.rebalance.enable": "all",        │
│        "cluster.routing.allocation.node_concurrent       │
│         _recoveries": 2,                                 │
│        "indices.recovery.max_bytes_per_sec": "50mb"      │
│      }                                                   │
│    }                                                     │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 6. Elasticsearch 自动重新分配分片                        │
│    - 计算最优分片分布                                     │
│    - 移动分片到目标节点                                   │
│    - 并发恢复 (最多2个分片/节点)                          │
│    - 限速传输 (50mb/s)                                    │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 7. 监控重平衡进度                                        │
│    GET /_cat/recovery?v&active_only=true                 │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 8. 重平衡完成                                            │
│    - 分片均匀分布在所有节点                               │
│    - 恢复正常服务                                         │
└─────────────────────────────────────────────────────────┘
```

## 热点分片优化流程

```
┌─────────────────────────────────────────────────────────┐
│ 1. 热点检测                                              │
│    hasHotShards(stats)                                   │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 2. 收集分片指标                                          │
│    - 每个分片的QPS                                       │
│    - CPU使用率                                           │
│    - 内存使用率                                          │
│    - 磁盘I/O                                             │
│    - 响应延迟                                            │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 3. 识别热点分片                                          │
│    判断条件：                                             │
│    - QPS > 平均值 × 2                                    │
│    - CPU > 80%                                           │
│    - 延迟 > P95 × 1.5                                    │
└─────────┬──────────────┬────────────────────────────────┘
          │ 有热点        │ 无热点
          ▼              ▼
┌────────────────┐  ┌──────────────────┐
│ 4a. 触发优化    │  │ 4b. 继续监控      │
└────────┬───────┘  └──────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│ 5. 优化分片分配                                          │
│    optimizeShardAllocation()                             │
│                                                          │
│    调整权重：                                             │
│    - 分片级别平衡: 0.45                                   │
│    - 索引级别平衡: 0.55                                   │
│    - 平衡阈值: 1.0                                        │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 6. Elasticsearch 重新分配热点分片                        │
│    - 将热点分片移到负载较低的节点                         │
│    - 优化分片在索引和节点间的分布                         │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 7. 验证优化效果                                          │
│    - 检查热点是否消除                                     │
│    - 监控整体性能提升                                     │
└─────────────────────────────────────────────────────────┘
```

## 分片状态监控

```
┌──────────────────────────────────────────────────────────┐
│                     监控指标层次                          │
├──────────────────────────────────────────────────────────┤
│                                                           │
│  ┌────────────────────────────────────────────────────┐  │
│  │ 1. 集群级别                                         │  │
│  │    - 总节点数                                       │  │
│  │    - 总分片数                                       │  │
│  │    - 主分片数                                       │  │
│  │    - 副本分片数                                     │  │
│  │    - 未分配分片数                                   │  │
│  └────────────────────────────────────────────────────┘  │
│              ↓                                            │
│  ┌────────────────────────────────────────────────────┐  │
│  │ 2. 节点级别                                         │  │
│  │    - 每个节点的分片数                               │  │
│  │    - 节点CPU使用率                                  │  │
│  │    - 节点内存使用率                                 │  │
│  │    - 节点磁盘使用率                                 │  │
│  │    - 节点网络I/O                                    │  │
│  └────────────────────────────────────────────────────┘  │
│              ↓                                            │
│  ┌────────────────────────────────────────────────────┐  │
│  │ 3. 索引级别                                         │  │
│  │    - 索引分片数                                     │  │
│  │    - 索引文档数                                     │  │
│  │    - 索引存储大小                                   │  │
│  │    - 索引QPS                                        │  │
│  │    - 索引平均延迟                                   │  │
│  └────────────────────────────────────────────────────┘  │
│              ↓                                            │
│  ┌────────────────────────────────────────────────────┐  │
│  │ 4. 分片级别                                         │  │
│  │    - 分片状态 (STARTED/RELOCATING/INITIALIZING)    │  │
│  │    - 分片大小                                       │  │
│  │    - 分片文档数                                     │  │
│  │    - 分片所在节点                                   │  │
│  │    - 主/副本标识                                    │  │
│  └────────────────────────────────────────────────────┘  │
│                                                           │
└──────────────────────────────────────────────────────────┘
```

## API调用时序图

```
用户/系统        Manager API      ShardController    Elasticsearch
    |                |                  |                  |
    | GET /shards    |                  |                  |
    |--------------->|                  |                  |
    |                | getClusterStats()|                  |
    |                |----------------->|                  |
    |                |                  | GET /_cluster/stats
    |                |                  |----------------->|
    |                |                  | 返回集群状态      |
    |                |                  |<-----------------|
    |                | 返回分片信息      |                  |
    |                |<-----------------|                  |
    | 返回JSON数据   |                  |                  |
    |<---------------|                  |                  |
    |                |                  |                  |
    | POST /shards   |                  |                  |
    | action=rebalance                  |                  |
    |--------------->|                  |                  |
    |                | rebalanceShards()|                  |
    |                |----------------->|                  |
    |                |                  | PUT /_cluster/settings
    |                |                  | 设置重平衡参数    |
    |                |                  |----------------->|
    |                |                  | 确认接收         |
    |                |                  |<-----------------|
    |                |                  |                  |
    |                |                  |        Elasticsearch开始重平衡
    |                |                  |                  |-----.
    |                |                  |                  |     | 重新分配分片
    |                |                  |                  |<----'
    |                | 返回成功         |                  |
    |                |<-----------------|                  |
    | "Shard rebalancing triggered"    |                  |
    |<---------------|                  |                  |
    |                |                  |                  |
```

## 分片生命周期

```
┌─────────────────────────────────────────────────────────┐
│                   分片生命周期                            │
└─────────────────────────────────────────────────────────┘

  创建索引
      ↓
  ┌─────────────┐
  │ UNASSIGNED  │  未分配状态（刚创建）
  └──────┬──────┘
         │
         │ Elasticsearch 分配决策
         ▼
  ┌─────────────┐
  │ INITIALIZING│  初始化中（数据正在复制）
  └──────┬──────┘
         │
         │ 数据复制完成
         ▼
  ┌─────────────┐
  │   STARTED   │  正常运行状态
  └──────┬──────┘
         │
         │ 触发重平衡
         ▼
  ┌─────────────┐
  │ RELOCATING  │  重新定位中（移动到新节点）
  └──────┬──────┘
         │
         │ 移动完成
         ▼
  ┌─────────────┐
  │   STARTED   │  在新节点上正常运行
  └──────┬──────┘
         │
         │ 删除索引/节点下线
         ▼
  ┌─────────────┐
  │   DELETED   │  分片被删除
  └─────────────┘
```

## 分片分布示例

### 初始状态（不平衡）

```
节点1: ████████████ (12个分片)
节点2: ████ (4个分片)
节点3: ██ (2个分片)
─────────────────────────────
平均: 6个分片/节点
方差: 高 ⚠️ 需要重平衡
```

### 重平衡后

```
节点1: ██████ (6个分片)
节点2: ██████ (6个分片)
节点3: ██████ (6个分片)
─────────────────────────────
平均: 6个分片/节点
方差: 0 ✅ 完美平衡
```

## 性能影响对比

```
┌────────────────────────────────────────────────────────┐
│                   重平衡前 vs 重平衡后                  │
├────────────────────────────────────────────────────────┤
│                                                         │
│  查询延迟 (ms)                                          │
│                                                         │
│  节点1: ████████████████ 150ms                          │
│  节点2: ██████ 60ms                                     │
│  节点3: ████ 40ms                                       │
│  ─────────────────────────                             │
│  平均: 83ms  方差: 高                                   │
│                                                         │
│              ↓ 重平衡                                   │
│                                                         │
│  节点1: ████████ 80ms                                   │
│  节点2: ████████ 80ms                                   │
│  节点3: ████████ 80ms                                   │
│  ─────────────────────────                             │
│  平均: 80ms  方差: 0  ✅ 性能提升 3.6%                  │
│                                                         │
└────────────────────────────────────────────────────────┘
```

## 配置参数速查表

| 参数 | 默认值 | 作用 | 调优建议 |
|------|--------|------|----------|
| `cluster.routing.rebalance.enable` | `all` | 启用重平衡 | 维护时设为`none` |
| `cluster.routing.allocation.node_concurrent_recoveries` | `2` | 并发恢复数 | 高性能集群可设为4-8 |
| `indices.recovery.max_bytes_per_sec` | `50mb` | 恢复速率 | 低峰期可提高到200mb |
| `cluster.routing.allocation.balance.shard` | `0.45` | 分片平衡权重 | 通常不需要调整 |
| `cluster.routing.allocation.balance.index` | `0.55` | 索引平衡权重 | 通常不需要调整 |
| `cluster.routing.allocation.balance.threshold` | `1.0` | 平衡阈值 | 降低可提高平衡程度 |

## 常用命令速查

```bash
# 查看分片分布
curl -s http://localhost:9200/_cat/shards?v

# 查看集群健康
curl -s http://localhost:9200/_cluster/health?pretty

# 查看未分配分片
curl -s http://localhost:9200/_cat/shards?v | grep UNASSIGNED

# 查看重平衡进度
curl -s http://localhost:9200/_cat/recovery?v&active_only=true

# 手动触发重平衡（通过Manager API）
curl -X POST http://localhost:8080/shards \
  -H "Content-Type: application/json" \
  -d '{"action": "rebalance"}'

# 查看分片分配解释
curl -s http://localhost:9200/_cluster/allocation/explain?pretty

# 禁用分片分配（维护用）
curl -X PUT http://localhost:9200/_cluster/settings \
  -H "Content-Type: application/json" \
  -d '{"transient": {"cluster.routing.allocation.enable": "none"}}'

# 启用分片分配
curl -X PUT http://localhost:9200/_cluster/settings \
  -H "Content-Type: application/json" \
  -d '{"transient": {"cluster.routing.allocation.enable": "all"}}'
```

## 总结

ES Serverless的分片策略通过ShardController实现了：

✅ **自动化监控**：每30秒检查一次集群状态  
✅ **智能决策**：基于分片分布和负载自动判断  
✅ **灵活控制**：支持手动触发和自动执行  
✅ **性能优化**：热点检测和优化分配  
✅ **可观测性**：完整的监控和API接口  

核心代码位置：`/server/shard_controller.go`
