# ES Serverless 平台时序图集合

本文档包含ES Serverless平台所有主要接口和功能的文字时序图。

---

## 目录

1. [创建容器组](#1-创建容器组)
2. [删除容器组](#2-删除容器组)
3. [重启容器](#3-重启容器)
4. [查询服务列表](#4-查询服务列表)
5. [查询服务详情](#5-查询服务详情)
6. [查询容器列表](#6-查询容器列表)
7. [创建向量索引](#7-创建向量索引)
8. [向量检索](#8-向量检索)
9. [查询索引数据](#9-查询索引数据)
10. [添加索引数据](#10-添加索引数据)
11. [查询容器监控系统](#11-查询容器监控系统)
12. [查询QPS数据](#12-查询qps数据)
13. [自动扩缩容流程](#13-自动扩缩容流程)
14. [索引元数据管理](#14-索引元数据管理)
15. [租户配额管理](#15-租户配额管理)
16. [部署状态管理](#16-部署状态管理)
17. [租户容器管理](#17-租户容器管理)
18. [部署报告查询](#18-部署报告查询)
19. [日志收集流程](#19-日志收集流程)
20. [数据上报流程](#20-数据上报流程)

---

## 1. 创建容器组

```
用户          Manager服务      元数据服务      K8s集群      GitLab      上报服务
 |                |               |              |            |            |
 | POST /clusters |               |              |            |            |
 |--------------->|               |              |            |            |
 |                |               |              |            |            |
 |                | 验证参数       |              |            |            |
 |                |---------------|              |            |            |
 |                |               |              |            |            |
 |                | 检查配额       |              |            |            |
 |                |-------------->|              |            |            |
 |                | 返回配额       |              |            |            |
 |                |<--------------|              |            |            |
 |                |               |              |            |            |
 |                | ⭐记录租户元数据 (第一步)     |            |            |
 |                |-------------->|              |            |            |
 |                | 元数据保存成功 |              |            |            |
 |                |<--------------|              |            |            |
 |                | (记录: user, service_name,   |            |            |
 |                |  cpu, memory, disk, gpu,     |            |            |
 |                |  dimension, vector_count,    |            |            |
 |                |  replicas, namespace, status=creating)   |
 |                |               |              |            |            |
 |                | 📊上报: starting              |            |            |
 |                |--------------------------------------------->|
 |                | 接收上报       |              |            |            |
 |                |<---------------------------------------------|            |
 |                |               |              |            |            |
 |                | 拉取配置(可选) |              |            |            |
 |                |--------------------------------->|         |            |
 |                | 返回配置       |              |            |            |
 |                |<---------------------------------|         |            |
 |                | 📊上报: gitlab_pulled         |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                | 创建Namespace  |              |            |            |
 |                |-------------------------->|              |            |
 |                | Namespace创建  |              |            |            |
 |                |<--------------------------|              |            |
 |                | 📊上报: namespace_created     |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                | 创建StatefulSet (设置环境变量) |            |            |
 |                |-------------------------->|              |            |
 |                | StatefulSet创建|              |            |            |
 |                |<--------------------------|              |            |
 |                |               |              |            |            |
 |                | 创建Service    |              |            |            |
 |                |-------------------------->|              |            |
 |                | Service创建    |              |            |            |
 |                |<--------------------------|              |            |
 |                | 📊上报: k8s_applied           |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                | 创建PVC        |              |            |            |
 |                |-------------------------->|              |            |
 |                | PVC创建        |              |            |            |
 |                |<--------------------------|              |            |
 |                |               |              |            |            |
 |                | 配置资源限制   |              |            |            |
 |                |-------------------------->|              |            |
 |                | 配置成功       |              |            |            |
 |                |<--------------------------|              |            |
 |                | 📊上报: resources_configured  |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                | 配置磁盘大小   |              |            |            |
 |                |-------------------------->|              |            |
 |                | 配置成功       |              |            |            |
 |                |<--------------------------|              |            |
 |                | 📊上报: disk_configured       |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                | 配置GPU数量    |              |            |            |
 |                |-------------------------->|              |            |
 |                | 配置成功       |              |            |            |
 |                |<--------------------------|              |            |
 |                | 📊上报: gpu_configured        |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                | 等待Pod就绪    |              |            |            |
 |                |-------------------------->|              |            |
 |                | Pod运行中      |              |            |            |
 |                |<--------------------------|              |            |
 |                | 📊上报: rollout_completed     |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                | 同步到租户管理 |              |            |            |
 |                |-------------->|              |            |            |
 |                | 同步完成       |              |            |            |
 |                |<--------------|              |            |            |
 |                | 📊上报: tenant_synced         |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                | 更新状态=created              |            |            |
 |                |-------------->|              |            |            |
 |                | 更新成功       |              |            |            |
 |                |<--------------|              |            |            |
 |                | 📊上报: completed             |            |            |
 |                |--------------------------------------------->|
 |                |               |              |            |            |
 |                |               |              | Pod上报启动信息          |
 |                |               |              |----------------------->|
 |                |               |              | 接收数据   |            |
 |                |               |              |<-----------------------|
 |                |               |              |            |            |
 | 返回创建结果   |               |              |            |            |
 |<---------------|               |              |            |            |ƒ
 |                |               |              |            |            |
```

**环境变量说明**:
- CPU_REQUEST, CPU_LIMIT: CPU资源配置
- MEM_REQUEST, MEM_LIMIT: 内存资源配置
- DISK_SIZE: 磁盘大小
- GPU_COUNT: GPU数量
- DIMENSION: 向量维度
- VECTOR_COUNT: 向量数量
- REPLICAS: 副本数量

**📊 部署状态上报步骤**（共9次上报）：

1. **starting** - 开始创建集群
   - 时机：在创建任何资源之前
   - 内容：用户、服务名、命名空间、配置参数

2. **namespace_created** - Namespace创建成功
   - 时机：Kubernetes Namespace创建完成后
   - 内容：命名空间信息

3. **gitlab_pulled** - GitLab资源拉取成功
   - 时机：从GitLab拉取配置文件完成后（如果提供了GitLab URL）
   - 内容：拉取状态

4. **k8s_applied** - Kubernetes资源应用成功
   - 时机：StatefulSet、Service等核心资源创建完成后
   - 内容：创建的资源列表

5. **resources_configured** - 集群资源配置成功
   - 时机：CPU、内存资源限制设置完成后
   - 内容：CPU、内存配置值

6. **disk_configured** - 磁盘大小配置成功
   - 时机：PVC磁盘大小配置完成后
   - 内容：磁盘大小配置

7. **gpu_configured** - GPU数量配置成功（如果GPU_COUNT > 0）
   - 时机：GPU资源配置完成后
   - 内容：GPU数量

8. **rollout_completed** - 集群就绪完成
   - 时机：Pod成功启动并运行后
   - 内容：就绪状态

9. **tenant_synced** - 租户容器管理同步完成
   - 时机：数据同步到租户容器管理系统完成后
   - 内容：同步状态

10. **completed** - 集群创建完成
    - 时机：所有步骤成功完成后
    - 内容：最终状态、完整配置信息

**上报数据格式**：
```json
{
  "user": "用户ID",
  "service_name": "服务名称",
  "namespace": "命名空间",
  "status": "状态标识",
  "message": "状态描述",
  "timestamp": "时间戳",
  "details": {
    "replicas": 副本数,
    "cpu_request": "CPU请求",
    "cpu_limit": "CPU限制",
    "mem_request": "内存请求",
    "mem_limit": "内存限制",
    "disk_size": "磁盘大小",
    "gpu_count": GPU数量,
    "dimension": 向量维度,
    "vector_count": 向量数量
  }
}
```

**上报存储位置**：
- 报告文件：`server/deployment_reports/{user}_{service_name}_{timestamp}.json`
- 日志文件：`/tmp/deployment.log`

---

## 2. 删除容器组

```
用户          Manager服务      元数据服务      K8s集群
 |                |               |              |
 | DELETE /clusters              |              |
 |--------------->|               |              |
 |                |               |              |
 |                | 验证权限       |              |
 |                |-------------->|              |
 |                | 权限验证通过   |              |
 |                |<--------------|              |
 |                |               |              |
 |                | 删除StatefulSet|             |
 |                |-------------------------->|  |
 |                | 删除成功       |              |
 |                |<--------------------------|  |
 |                |               |              |
 |                | 删除Service    |              |
 |                |-------------------------->|  |
 |                | 删除成功       |              |
 |                |<--------------------------|  |
 |                |               |              |
 |                | 删除PVC        |              |
 |                |-------------------------->|  |
 |                | 删除成功       |              |
 |                |<--------------------------|  |
 |                |               |              |
 |                | 删除Namespace  |              |
 |                |-------------------------->|  |
 |                | 删除成功       |              |
 |                |<--------------------------|  |
 |                |               |              |
 |                | 更新部署状态   |              |
 |                | (status: deleted)          |
 |                |-------------->|              |
 |                | 状态更新成功   |              |
 |                |<--------------|              |
 |                |               |              |
 |                | 删除租户容器记录              |
 |                |-------------->|              |
 |                | 删除成功       |              |
 |                |<--------------|              |
 |                |               |              |
 | 返回删除结果   |               |              |
 |<---------------|               |              |
 |                |               |              |
```

---

## 3. 重启容器

```
用户          Manager服务      K8s集群
 |                |              |
 | POST /restart  |              |
 |--------------->|              |
 |                |              |
 |                | 获取Pod列表   |
 |                |------------>|
 |                | 返回Pod列表   |
 |                |<------------|
 |                |              |
 |                | 删除Pod      |
 |                | (触发自动重启)|
 |                |------------>|
 |                | 删除成功     |
 |                |<------------|
 |                |              |
 |                | 等待Pod重启   |
 |                |------------>|
 |                | Pod运行中    |
 |                |<------------|
 |                |              |
 | 返回重启结果   |              |
 |<---------------|              |
 |                |              |
```

---

## 4. 查询服务列表

```
用户          Manager服务      元数据服务      K8s集群
 |                |               |              |
 | GET /clusters  |               |              |
 |--------------->|               |              |
 |                |               |              |
 |                | 查询部署列表   |              |
 |                |-------------->|              |
 |                | 返回部署列表   |              |
 |                |<--------------|              |
 |                |               |              |
 |                | 查询K8s状态    |              |
 |                |-------------------------->|  |
 |                | 返回实时状态   |              |
 |                |<--------------------------|  |
 |                |               |              |
 |                | 合并数据       |              |
 |                |---------------|              |
 |                |               |              |
 | 返回服务列表   |               |              |
 |<---------------|               |              |
 |                |               |              |
```

**返回数据包含**:
- namespace: 命名空间
- user: 用户
- service_name: 服务名称
- status: 运行状态
- replicas: 副本数量
- cpu_usage: CPU使用率
- memory_usage: 内存使用率
- qps: 每秒查询数

---

## 5. 查询服务详情

```
用户          Manager服务      元数据服务      K8s集群
 |                |               |              |
 | GET /clusters/{namespace}     |              |
 |--------------->|               |              |
 |                |               |              |
 |                | 查询部署状态   |              |
 |                |-------------->|              |
 |                | 返回部署信息   |              |
 |                |<--------------|              |
 |                |               |              |
 |                | 查询容器指标   |              |
 |                |-------------->|              |
 |                | 返回监控指标   |              |
 |                |<--------------|              |
 |                |               |              |
 |                | 查询K8s详情    |              |
 |                |-------------------------->|  |
 |                | 返回实时详情   |              |
 |                |<--------------------------|  |
 |                |               |              |
 |                | 合并数据       |              |
 |                |---------------|              |
 |                |               |              |
 | 返回详细信息   |               |              |
 |<---------------|               |              |
 |                |               |              |
```

**返回数据包含**:
- 基本信息: user, service_name, namespace
- 资源配置: CPU, 内存, 硬盘, GPU
- 向量配置: dimension, vector_count
- 运行状态: status, replicas
- 实时指标: cpu_usage, memory_usage, disk_usage, qps

---

## 6. 查询容器列表

```
用户          Manager服务      K8s集群
 |                |              |
 | GET /containers|             |
 |--------------->|              |
 |                |              |
 |                | 查询所有Pod   |
 |                |------------>|
 |                | 返回Pod列表   |
 |                |<------------|
 |                |              |
 |                | 格式化数据    |
 |                |--------------|
 |                |              |
 | 返回容器列表   |              |
 |<---------------|              |
 |                |              |
```

**返回数据包含**:
- pod_name: Pod名称
- namespace: 命名空间
- status: 运行状态
- node: 所在节点
- cpu: CPU使用
- memory: 内存使用
- age: 运行时间

---

## 7. 创建向量索引

```
用户          Manager服务      ES集群        元数据服务
 |                |              |              |
 | POST /vector-indexes         |              |
 |--------------->|              |              |
 |                |              |              |
 |                | 验证参数     |              |
 |                |--------------|              |
 |                |              |              |
 |                | 创建索引     |              |
 |                |------------>|              |
 |                | 设置mapping  |              |
 |                | (vector type)|              |
 |                | 配置IVF参数  |              |
 |                | 索引创建成功 |              |
 |                |<------------|              |
 |                |              |              |
 |                | 保存索引元数据              |
 |                |------------------------->|  |
 |                | 保存成功     |              |
 |                |<-------------------------|  |
 |                |              |              |
 | 返回创建结果   |              |              |
 |<---------------|              |              |
 |                |              |              |
```

**请求参数**:
- index_name: 索引名称
- dimension: 向量维度
- metric: 距离度量(l2/cosine/dot)
- ivf_params:
  - nlist: 倒排簇数
  - nprobe: 搜索簇数

---

## 8. 向量检索

```
用户          ES集群        IVF插件      向量存储
 |              |              |            |
 | POST /_search               |            |
 |------------->|              |            |
 |              |              |            |
 |              | 解析查询     |            |
 |              |--------------|            |
 |              |              |            |
 |              | 调用IVF搜索  |            |
 |              |------------>|            |
 |              |              |            |
 |              |              | 加载centroids
 |              |              |---------->|
 |              |              | 返回centroids
 |              |              |<----------|
 |              |              |            |
 |              |              | 计算距离   |
 |              |              | 选择nprobe个簇
 |              |              |------------|
 |              |              |            |
 |              |              | 加载倒排表  |
 |              |              |---------->|
 |              |              | 返回向量列表|
 |              |              |<----------|
 |              |              |            |
 |              |              | 精确计算距离|
 |              |              | 排序TopK   |
 |              |              |------------|
 |              |              |            |
 |              | 返回搜索结果 |            |
 |              |<------------|            |
 |              |              |            |
 |              | 应用过滤条件 |            |
 |              |--------------|            |
 |              |              |            |
 | 返回最终结果 |              |            |
 |<-------------|              |            |
 |              |              |            |
```

**查询流程**:
1. 粗排: 在cluster centroids中找最近的nprobe个簇
2. 精排: 在选中的簇中精确计算距离
3. 过滤: 应用结构化过滤条件
4. 排序: 返回TopK结果

---

## 9. 查询索引数据

```
用户          Manager服务      ES集群
 |                |              |
 | GET /indexes/{name}/data     |
 |--------------->|              |
 |                |              |
 |                | 查询索引     |
 |                |------------>|
 |                | 返回文档列表 |
 |                |<------------|
 |                |              |
 | 返回索引数据   |              |
 |<---------------|              |
 |                |              |
```

---

## 10. 添加索引数据

```
用户          Manager服务      ES集群        上报服务
 |                |              |              |
 | POST /indexes/{name}/data    |              |
 |--------------->|              |              |
 |                |              |              |
 |                | 批量写入     |              |
 |                |------------>|              |
 |                | 写入成功     |              |
 |                |<------------|              |
 |                |              |              |
 |                |              | 插件上报统计 |
 |                |              |------------>|
 |                |              | 接收统计     |
 |                |              |<------------|
 |                |              |              |
 | 返回写入结果   |              |              |
 |<---------------|              |              |
 |                |              |              |
```

---

## 11. 查询容器监控系统

```
用户          Manager服务      元数据服务      Prometheus
 |                |               |              |
 | GET /monitoring/container-metrics           |
 |--------------->|               |              |
 |                |               |              |
 |                | 查询持久化指标|              |
 |                |-------------->|              |
 |                | 返回历史指标  |              |
 |                |<--------------|              |
 |                |               |              |
 |                | 查询实时指标  |              |
 |                |------------------------------>|
 |                | 返回实时数据  |              |
 |                |<------------------------------|
 |                |               |              |
 |                | 合并数据      |              |
 |                |---------------|              |
 |                |               |              |
 | 返回监控数据   |               |              |
 |<---------------|               |              |
 |                |               |              |
```

**返回数据包含**:
- 容器上线数据: startup_cpu, startup_memory, startup_disk
- 实时数据: cpu_usage, memory_usage, disk_usage
- 插件数据: plugin_qps, qps
- 资源限制: resource_limits, resource_requests

---

## 12. 查询QPS数据

```
用户          Manager服务      元数据服务      上报服务
 |                |               |              |
 | GET /qps/{namespace}          |              |
 |--------------->|               |              |
 |                |               |              |
 |                | 查询容器指标  |              |
 |                |-------------->|              |
 |                | 返回QPS数据   |              |
 |                |<--------------|              |
 |                |               |              |
 |                | 查询最新上报  |              |
 |                |------------------------------>|
 |                | 返回最新QPS   |              |
 |                |<------------------------------|
 |                |               |              |
 | 返回QPS指标    |               |              |
 |<---------------|               |              |
 |                |               |              |
```

**返回数据包含**:
- namespace: 命名空间
- qps: 每秒查询数
- timestamp: 时间戳
- container_name: 容器名称

---

## 13. 自动扩缩容流程

```
定时器        Autoscaler      元数据服务      K8s集群      监控系统
 |                |               |              |            |
 | 触发检查(1分钟) |               |              |            |
 |--------------->|               |              |            |
 |                |               |              |            |
 |                | 获取部署列表  |              |            |
 |                |-------------->|              |            |
 |                | 返回部署列表  |              |            |
 |                |<--------------|              |            |
 |                |               |              |            |
 |                | 获取监控指标  |              |            |
 |                |------------------------------------->|    |
 |                | 返回指标数据  |              |            |
 |                |<-------------------------------------|    |
 |                |               |              |            |
 |                | 更新历史指标  |              |            |
 |                |---------------|              |            |
 |                |               |              |            |
 |                | 计算趋势分析  |              |            |
 |                | (CPU/内存/磁盘/QPS)         |            |
 |                |---------------|              |            |
 |                |               |              |            |
 |                | 调整指标权重  |              |            |
 |                | (基于趋势)    |              |            |
 |                |---------------|              |            |
 |                |               |              |            |
 |                | 获取用户策略  |              |            |
 |                |-------------->|              |            |
 |                | 返回扩缩容策略|              |            |
 |                |<--------------|              |            |
 |                |               |              |            |
 |                | 计算新副本数  |              |            |
 |                |---------------|              |            |
 |                |               |              |            |
 |                | 检查冷却期    |              |            |
 |                |---------------|              |            |
 |                | (扩容5分钟/缩容10分钟)      |            |
 |                |               |              |            |
 |                | 执行扩缩容    |              |            |
 |                |-------------------------->|  |            |
 |                | 扩缩容成功    |              |            |
 |                |<--------------------------|  |            |
 |                |               |              |            |
 |                | 更新部署状态  |              |            |
 |                |-------------->|              |            |
 |                | 状态更新成功  |              |            |
 |                |<--------------|              |            |
 |                |               |              |            |
 |                | 记录扩缩容时间|              |            |
 |                |---------------|              |            |
 |                |               |              |            |
```

**扩缩容决策逻辑**:
1. 收集指标: CPU、内存、磁盘、QPS
2. 趋势分析: 计算最近5次指标的变化趋势
3. 权重调整: 根据趋势调整指标权重(±10%)
4. 阈值比较: 与用户配置的阈值比较
5. 冷却期检查: 避免频繁扩缩容
6. 执行决策: 调整副本数量

---

## 14. 索引元数据管理

```
用户          Manager服务      元数据服务
 |                |               |
 | POST /metadata/indexes        |
 |--------------->|               |
 |                |               |
 |                | 保存索引元数据|
 |                |-------------->|
 |                | 保存成功      |
 |                |<--------------|
 |                |               |
 | 返回结果       |               |
 |<---------------|               |
 |                |               |
 | GET /metadata/indexes         |
 |--------------->|               |
 |                |               |
 |                | 查询索引列表  |
 |                |-------------->|
 |                | 返回列表      |
 |                |<--------------|
 |                |               |
 | 返回索引列表   |               |
 |<---------------|               |
 |                |               |
```

**元数据包含**:
- index_name: 索引名称
- namespace: 命名空间
- dimension: 向量维度
- metric: 距离度量
- ivf_params: IVF参数
- created_by: 创建者
- status: 状态
- created_at: 创建时间

---

## 15. 租户配额管理

```
用户          Manager服务      元数据服务
 |                |               |
 | GET /metadata/tenants/{user}  |
 |--------------->|               |
 |                |               |
 |                | 查询租户配额  |
 |                |-------------->|
 |                | 返回配额信息  |
 |                |<--------------|
 |                |               |
 | 返回配额       |               |
 |<---------------|               |
 |                |               |
 | PUT /metadata/tenants/{user}  |
 |--------------->|               |
 |                |               |
 |                | 更新配额      |
 |                |-------------->|
 |                | 更新成功      |
 |                |<--------------|
 |                |               |
 | 返回结果       |               |
 |<---------------|               |
 |                |               |
```

**配额信息包含**:
- user_id: 用户ID
- max_clusters: 最大集群数
- max_indexes: 最大索引数
- max_cpu: 最大CPU
- max_memory: 最大内存
- max_storage: 最大存储
- current_usage: 当前使用量

---

## 16. 部署状态管理

```
用户          Manager服务      元数据服务
 |                |               |
 | GET /metadata/deployments     |
 |--------------->|               |
 |                |               |
 |                | 查询部署状态  |
 |                |-------------->|
 |                | 返回状态列表  |
 |                |<--------------|
 |                |               |
 | 返回部署状态   |               |
 |<---------------|               |
 |                |               |
 | PUT /metadata/deployments/{ns}|
 |--------------->|               |
 |                |               |
 |                | 更新部署状态  |
 |                |-------------->|
 |                | 更新成功      |
 |                |<--------------|
 |                |               |
 | 返回结果       |               |
 |<---------------|               |
 |                |               |
```

**状态信息包含**:
- namespace: 命名空间
- user: 用户
- service_name: 服务名称
- status: 状态(creating/running/scaling/error/deleted)
- replicas: 副本数量
- cpu_usage: CPU使用率
- memory_usage: 内存使用率
- created_at: 创建时间
- updated_at: 更新时间

---

## 17. 租户容器管理

```
用户          Manager服务      元数据服务
 |                |               |
 | GET /tenant/containers        |
 |--------------->|               |
 |                |               |
 |                | 查询租户容器  |
 |                |-------------->|
 |                | 返回容器列表  |
 |                |<--------------|
 |                |               |
 | 返回容器列表   |               |
 |<---------------|               |
 |                |               |
 | GET /tenant/containers/{user}/{service}
 |--------------->|               |
 |                |               |
 |                | 查询容器详情  |
 |                |-------------->|
 |                | 返回容器信息  |
 |                |<--------------|
 |                |               |
 | 返回容器详情   |               |
 |<---------------|               |
 |                |               |
```

**容器信息包含**:
- user: 用户
- service_name: 服务名称
- namespace: 命名空间
- replicas: 副本数
- cpu: CPU配置
- memory: 内存配置
- disk: 磁盘配置
- status: 状态
- created_at: 创建时间
- sync_time: 同步时间

---

## 18. 部署报告查询

```
用户          Manager服务      元数据服务
 |                |               |
 | GET /deployment/reports       |
 |--------------->|               |
 |                |               |
 |                | 查询部署报告  |
 |                |-------------->|
 |                | 返回报告列表  |
 |                |<--------------|
 |                |               |
 | 返回报告列表   |               |
 |<---------------|               |
 |                |               |
 | GET /deployment/reports/{user}/{service}
 |--------------->|               |
 |                |               |
 |                | 查询最新报告  |
 |                |-------------->|
 |                | 返回报告详情  |
 |                |<--------------|
 |                |               |
 | 返回报告详情   |               |
 |<---------------|               |
 |                |               |
```

**报告信息包含**:
- report_id: 报告ID
- user: 用户
- service_name: 服务名称
- namespace: 命名空间
- status: 部署状态
- message: 状态消息
- replicas: 副本数
- resources: 资源配置
- timestamp: 时间戳

---

## 19. 日志收集流程

```
容器          Fluentd        Elasticsearch    本地文件
 |              |                 |              |
 | 输出日志     |                 |              |
 |------------->|                 |              |
 |              |                 |              |
 |              | 解析日志        |              |
 |              |-----------------|              |
 |              |                 |              |
 |              | 添加K8s元数据   |              |
 |              | (namespace,pod等)            |
 |              |-----------------|              |
 |              |                 |              |
 |              | 过滤命名空间    |              |
 |              | (es-serverless) |              |
 |              |-----------------|              |
 |              |                 |              |
 |              | 发送到ES        |              |
 |              |---------------->|              |
 |              | 索引成功        |              |
 |              |<----------------|              |
 |              |                 |              |
 |              | 写入本地文件    |              |
 |              |------------------------------>|
 |              | 写入成功        |              |
 |              |<------------------------------|
 |              |                 |              |
```

**日志处理流程**:
1. 收集: 从容器日志文件收集
2. 解析: JSON格式解析
3. 增强: 添加Kubernetes元数据
4. 过滤: 只收集es-serverless命名空间
5. 存储: 同时发送到Elasticsearch和本地文件
6. 索引: 按日期创建索引(k8s-{node}-{date})

---

## 20. 数据上报流程

```
ES插件        上报服务        元数据服务      Manager服务
 |              |               |               |
 | 收集统计数据 |               |               |
 |--------------|               |               |
 |              |               |               |
 | POST /report |               |               |
 |------------->|               |               |
 |              |               |               |
 |              | 验证数据      |               |
 |              |---------------|               |
 |              |               |               |
 |              | 保存指标      |               |
 |              |-------------->|               |
 |              | 保存成功      |               |
 |              |<--------------|               |
 |              |               |               |
 |              | 检查阈值      |               |
 |              |---------------|               |
 |              |               |               |
 |              | 触发告警(可选)|               |
 |              |------------------------------>|
 |              | 告警处理      |               |
 |              |<------------------------------|
 |              |               |               |
 | 返回上报结果 |               |               |
 |<-------------|               |               |
 |              |               |               |
```

**上报数据包含**:
- namespace: 命名空间
- container_name: 容器名称
- cpu_usage: CPU使用率
- memory_usage: 内存使用率
- disk_usage: 磁盘使用率
- qps: 每秒查询数
- startup_cpu: 启动时CPU
- startup_memory: 启动时内存
- startup_disk: 启动时磁盘
- plugin_qps: 插件QPS
- timestamp: 时间戳
- status: 状态

---

## 总结

本文档涵盖了ES Serverless平台的所有主要接口和功能的时序图，包括：

1. **容器管理**: 创建、删除、重启、查询
2. **向量检索**: 索引创建、数据添加、向量搜索
3. **监控系统**: 指标查询、QPS统计、容器监控
4. **自动扩缩容**: 智能决策、冷却期控制、趋势分析
5. **元数据管理**: 索引、租户、部署状态
6. **日志和上报**: 日志收集、数据上报

每个时序图都详细描述了：
- 参与的组件
- 数据流向
- 关键步骤
- 返回数据格式
