# ES 分片数据同步 - 快速参考

## 🚀 快速开始

### 启动服务

```bash
cd /Users/yunpeng/Documents/es项目/server
go run .
```

服务会自动启动以下组件：
- ✅ ShardController（分片重平衡控制器）
- ✅ ReplicationMonitor（副本同步监控器）
- ✅ MonitoringService（监控服务）
- ✅ Autoscaler（自动扩缩容）

---

## 📡 API 接口

### 1. 触发分片重平衡

```bash
curl -X POST http://localhost:8080/shards \
  -H "Content-Type: application/json" \
  -d '{"action": "rebalance"}'
```

**效果**：
- 更新 ES 集群设置
- 启动异步监控
- 每 5 秒打印恢复进度
- 自动完成或 30 分钟超时

### 2. 优化分片分配

```bash
curl -X POST http://localhost:8080/shards \
  -H "Content-Type: application/json" \
  -d '{"action": "optimize"}'
```

**效果**：
- 调整分片平衡权重
- 优化分片分配策略

### 3. 查询所有副本同步状态

```bash
curl -X GET http://localhost:8080/replication/status
```

**返回**：
```json
{
  "my_index_1": {
    "index": "my_index_1",
    "total_shards": 5,
    "replicated_shards": 5,
    "unreplicated_shards": 0,
    "replication_progress": 100.0,
    "status": "healthy"
  }
}
```

### 4. 查询单个索引副本状态

```bash
curl -X GET http://localhost:8080/replication/status/my_index_1
```

**返回**：
```json
{
  "index": "my_index_1",
  "total_shards": 5,
  "replicated_shards": 5,
  "unreplicated_shards": 0,
  "replication_progress": 100.0,
  "status": "healthy"
}
```

### 5. 查询分片信息

```bash
curl -X GET http://localhost:8080/shards
```

**返回**：集群统计信息（节点数、分片数等）

---

## 📊 状态说明

| 状态 | 说明 | 行为 |
|------|------|------|
| `healthy` | 所有分片副本同步正常 | 无需操作 |
| `syncing` | 正在同步中 | 监控进度 |
| `degraded` | 存在未分配的分片 | 记录警告 |
| `failed` | 同步失败 | 自动触发恢复 |

---

## 🔄 自动监控

### ShardController（分片重平衡）

- **检查间隔**：30 秒
- **触发条件**：
  - 分片分布不均衡
  - 平均每节点分片数 > 5
  - 存在热点分片

**日志示例**：
```
2024/01/01 10:00:00 Triggering shard rebalancing...
2024/01/01 10:00:00 Shard rebalancing triggered successfully
```

### ReplicationMonitor（副本同步监控）

- **检查间隔**：30 秒
- **监控内容**：
  - 所有索引的副本状态
  - 分片分配情况
  - 同步进度
  - 健康状态

**日志示例**：
```
========================================
[ReplicationMonitor] Replication Status Report
========================================
[INDEX] my_index_1: 100.0% (5/5 shards) - Status: healthy
[INDEX] my_index_2: 66.7% (2/3 shards) - Status: syncing
========================================
[SUMMARY] Total: 2 | Healthy: 1 | Syncing: 1 | Degraded: 0 | Failed: 0
========================================
```

### 重平衡进度监控

当触发重平衡后，会自动启动进度监控：

- **检查间隔**：5 秒
- **超时时间**：30 分钟

**日志示例**：
```
[REBALANCE] index_1[0]: 45.2% (stage: translog, node-1 -> node-2)
[REBALANCE] index_1[1]: 78.9% (stage: finalize, node-2 -> node-3)
[REBALANCE] Total active recoveries: 2
```

---

## 🛠️ 自动故障恢复

### 触发条件

当 ReplicationMonitor 检测到以下情况时，会自动触发恢复：

1. **未分配的分片**（UNASSIGNED）
2. **复制进度 < 50%** 的索引（状态为 `failed`）

### 恢复动作

```go
settings := map[string]interface{}{
    "transient": map[string]interface{}{
        "cluster.routing.allocation.enable": "all",
    },
}
err := esClient.UpdateClusterSettings(settings)
```

### 日志示例

```
[ALERT] Index my_index_3 replication FAILED: 40.0% complete
[RECOVERY] Triggering recovery for index: my_index_3
[RECOVERY] Found 3 unassigned shards: [2 3 4]
[RECOVERY] Allocation enabled for index: my_index_3
```

---

## 📁 代码结构

```
server/
├── es_client.go              # Elasticsearch 客户端
│   ├── UpdateClusterSettings()  # 更新集群设置
│   ├── GetRecoveryStatus()      # 获取恢复状态
│   ├── GetShardAllocation()     # 获取分片分配
│   └── GetClusterStats()        # 获取集群统计
│
├── shard_controller.go       # 分片重平衡控制器
│   ├── Start()                  # 启动定时监控
│   ├── checkAndRebalance()      # 检查并重平衡
│   ├── rebalanceShards()        # 触发重平衡
│   ├── optimizeShardAllocation()# 优化分配
│   └── monitorRebalanceProgress()# 监控进度
│
├── replication_monitor.go    # 副本同步监控器（NEW）
│   ├── Start()                  # 启动监控
│   ├── checkReplicationStatus() # 检查状态
│   ├── printReplicationReport() # 打印报告
│   ├── handleReplicationIssues()# 处理问题
│   ├── triggerRecovery()        # 触发恢复
│   ├── GetReplicationStatus()   # 查询单个索引
│   └── GetAllReplicationStatuses()# 查询所有索引
│
└── main.go                   # 主入口
    ├── 初始化 ShardController
    ├── 初始化 ReplicationMonitor
    └── 注册 API 路由
```

---

## 🧪 测试场景

### 场景 1：正常运行

1. 启动服务
2. 观察日志，应该每 30 秒打印一次监控报告
3. 查询状态：`curl http://localhost:8080/replication/status`
4. 所有索引状态应为 `healthy`

### 场景 2：触发重平衡

1. 触发重平衡：`curl -X POST http://localhost:8080/shards -d '{"action":"rebalance"}'`
2. 观察日志，应该每 5 秒打印重平衡进度
3. 等待完成（或 30 分钟超时）
4. 查询状态确认

### 场景 3：模拟故障

1. 手动停止一个 ES 节点（模拟）
2. 等待 30 秒，观察 ReplicationMonitor 日志
3. 应该检测到 `UNASSIGNED` 分片
4. 自动触发恢复
5. 查询状态确认

### 场景 4：查询 API

```bash
# 查询所有状态
curl http://localhost:8080/replication/status | jq

# 查询单个索引
curl http://localhost:8080/replication/status/my_index | jq

# 查询分片信息
curl http://localhost:8080/shards | jq
```

---

## 🐛 故障排查

### 问题：监控器没有启动

**检查**：
```bash
# 查看日志
tail -f /var/log/es-serverless-manager.log | grep "ReplicationMonitor"
```

**期望输出**：
```
[ReplicationMonitor] Starting replica synchronization monitoring...
```

### 问题：API 返回 404

**检查**：
```bash
# 确认服务运行
ps aux | grep manager

# 确认端口监听
lsof -i :8080
```

### 问题：重平衡一直在进行

**检查**：
```bash
# 查询 ES 恢复状态
curl http://localhost:9200/_recovery?active_only=true | jq

# 查看日志
tail -f /var/log/es-serverless-manager.log | grep "REBALANCE"
```

**可能原因**：
- 分片过大，同步时间长
- 网络带宽限制
- 节点资源不足

### 问题：自动恢复失败

**检查**：
```bash
# 查看恢复日志
tail -f /var/log/es-serverless-manager.log | grep "RECOVERY"

# 检查 ES 集群健康
curl http://localhost:9200/_cluster/health | jq
```

**可能原因**：
- ES 集群本身有问题
- 磁盘空间不足
- 分片分配策略限制

---

## 📚 相关文档

- [分片数据同步实现总结](/docs/分片数据同步实现总结.md)
- [分片数据同步实现进度](/docs/分片数据同步实现进度.md)
- [分片数据同步实现方案](/docs/分片数据同步实现方案.md)
- [分片策略说明](/docs/分片策略说明.md)
- [分片策略可视化](/docs/分片策略可视化.md)

---

## ⚙️ 配置参数

### ShardController

```go
checkInterval := 30 * time.Second  // 检查间隔
```

### ReplicationMonitor

```go
checkInterval := 30 * time.Second       // 检查间隔
syncDelayThreshold := 5000              // 同步延迟阈值（毫秒）
```

### 重平衡监控

```go
checkInterval := 5 * time.Second        // 检查间隔
timeout := 30 * time.Minute             // 超时时间
```

---

## 🔧 自定义配置

### 修改检查间隔

```go
// 在 main.go 中
replicationMonitor := NewReplicationMonitor(esClient)
replicationMonitor.SetCheckInterval(60 * time.Second)  // 改为 60 秒
replicationMonitor.Start()
```

### 修改同步延迟阈值

```go
replicationMonitor.SetSyncDelayThreshold(10000)  // 改为 10 秒
```

---

**快速参考版本**：v1.0  
**更新时间**：2024-01-01  
**适用版本**：ES Serverless Platform v1.x
