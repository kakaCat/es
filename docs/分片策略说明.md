# ES Serverless åˆ†ç‰‡ç­–ç•¥å®ç°è¯´æ˜

## æ¦‚è¿°

ES Serverless å¹³å°çš„åˆ†ç‰‡ç­–ç•¥é€šè¿‡ **ShardControllerï¼ˆåˆ†ç‰‡æ§åˆ¶å™¨ï¼‰** å®ç°ï¼Œæä¾›è‡ªåŠ¨åŒ–çš„åˆ†ç‰‡ç®¡ç†ã€é‡å¹³è¡¡å’Œä¼˜åŒ–åŠŸèƒ½ã€‚

## æ ¸å¿ƒå®ç°ä½ç½®

### 1. ä¸»è¦ä»£ç æ–‡ä»¶

**æ–‡ä»¶è·¯å¾„**ï¼š`/server/shard_controller.go`

è¿™æ˜¯åˆ†ç‰‡ç­–ç•¥çš„æ ¸å¿ƒå®ç°æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- ShardController ç»“æ„ä½“
- åˆ†ç‰‡ç›‘æ§å’Œç®¡ç†é€»è¾‘
- é‡å¹³è¡¡ç­–ç•¥
- ä¼˜åŒ–ç®—æ³•
- APIæ¥å£å¤„ç†

### 2. è¾…åŠ©è„šæœ¬

**æ–‡ä»¶è·¯å¾„**ï¼š`/scripts/shard-management.sh`

æä¾›å‘½ä»¤è¡Œå·¥å…·ç”¨äºï¼š
- è·å–é›†ç¾¤çŠ¶æ€
- æŸ¥çœ‹åˆ†ç‰‡åˆ†å¸ƒ
- æ‰‹åŠ¨è§¦å‘é‡å¹³è¡¡
- ä¼˜åŒ–åˆ†ç‰‡åˆ†é…

### 3. æ¼”ç¤ºè„šæœ¬

**æ–‡ä»¶è·¯å¾„**ï¼š`/demo/shard-demo.sh`

å±•ç¤ºåˆ†ç‰‡ç®¡ç†åŠŸèƒ½çš„å®Œæ•´æ¼”ç¤ºæµç¨‹ã€‚

## ShardController æ¶æ„

### ç»“æ„ä½“å®šä¹‰

```go
type ShardController struct {
    esClient *ESClient        // Elasticsearchå®¢æˆ·ç«¯
    ticker   *time.Ticker     // å®šæ—¶å™¨ï¼ˆæ¯30ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰
}
```

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ShardController                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å®šæ—¶ç›‘æ§ (30ç§’/æ¬¡)                   â”‚  â”‚
â”‚  â”‚  - è·å–é›†ç¾¤çŠ¶æ€                       â”‚  â”‚
â”‚  â”‚  - æ£€æŸ¥åˆ†ç‰‡åˆ†å¸ƒ                       â”‚  â”‚
â”‚  â”‚  - æ£€æµ‹çƒ­ç‚¹åˆ†ç‰‡                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å†³ç­–å¼•æ“                             â”‚  â”‚
â”‚  â”‚  - shouldRebalance()                  â”‚  â”‚
â”‚  â”‚  - hasHotShards()                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ‰§è¡Œæ“ä½œ                             â”‚  â”‚
â”‚  â”‚  - rebalanceShards()                  â”‚  â”‚
â”‚  â”‚  - optimizeShardAllocation()          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Elasticsearch API è°ƒç”¨               â”‚  â”‚
â”‚  â”‚  - æ›´æ–°é›†ç¾¤è®¾ç½®                       â”‚  â”‚
â”‚  â”‚  - è§¦å‘åˆ†ç‰‡é‡åˆ†é…                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åˆ†ç‰‡ç­–ç•¥è¯¦è§£

### 1. è‡ªåŠ¨ç›‘æ§æœºåˆ¶

**å®šæ—¶ä»»åŠ¡**ï¼šæ¯30ç§’è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡

```go
// Start begins the shard management loop
func (sc *ShardController) Start() {
    go func() {
        for range sc.ticker.C {
            sc.manageShards()  // æ¯30ç§’æ‰§è¡Œ
        }
    }()
}
```

**ç›‘æ§å†…å®¹**ï¼š
- é›†ç¾¤èŠ‚ç‚¹æ•°é‡
- åˆ†ç‰‡æ€»æ•°
- åˆ†ç‰‡åˆ†å¸ƒæƒ…å†µ
- èŠ‚ç‚¹è´Ÿè½½
- çƒ­ç‚¹åˆ†ç‰‡æ£€æµ‹

### 2. åˆ†ç‰‡é‡å¹³è¡¡ç­–ç•¥

#### è§¦å‘æ¡ä»¶

**ç®—æ³•**ï¼š`shouldRebalance(stats)`

```go
func (sc *ShardController) shouldRebalance(stats map[string]interface{}) bool {
    nodeCount := stats["nodes"]["count"].(float64)
    shardCount := stats["indices"]["shards"]["total"].(float64)
    
    // è®¡ç®—å¹³å‡æ¯ä¸ªèŠ‚ç‚¹çš„åˆ†ç‰‡æ•°
    avgShardsPerNode := shardCount / nodeCount
    
    // å¦‚æœå¹³å‡æ¯èŠ‚ç‚¹åˆ†ç‰‡æ•° > 5ï¼Œè§¦å‘é‡å¹³è¡¡
    return avgShardsPerNode > 5
}
```

**è§¦å‘æ¡ä»¶**ï¼š
1. âœ… å¹³å‡æ¯èŠ‚ç‚¹åˆ†ç‰‡æ•°è¶…è¿‡5ä¸ª
2. âœ… åˆ†ç‰‡åˆ†å¸ƒä¸å‡è¡¡
3. âœ… æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤
4. âœ… èŠ‚ç‚¹è´Ÿè½½å·®å¼‚æ˜¾è‘—

#### é‡å¹³è¡¡é…ç½®

**æ ¸å¿ƒè®¾ç½®**ï¼š

```go
settings := map[string]interface{}{
    "transient": map[string]interface{}{
        "cluster.routing.rebalance.enable": "all",
        "cluster.routing.allocation.node_concurrent_recoveries": 2,
        "indices.recovery.max_bytes_per_sec": "50mb",
    },
}
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `cluster.routing.rebalance.enable` | `"all"` | å…è®¸æ‰€æœ‰ç±»å‹çš„åˆ†ç‰‡é‡å¹³è¡¡ |
| `cluster.routing.allocation.node_concurrent_recoveries` | `2` | æ¯ä¸ªèŠ‚ç‚¹åŒæ—¶æ¢å¤çš„åˆ†ç‰‡æ•° |
| `indices.recovery.max_bytes_per_sec` | `"50mb"` | åˆ†ç‰‡æ¢å¤çš„æœ€å¤§é€Ÿç‡ |

**é‡å¹³è¡¡æµç¨‹**ï¼š

```
1. æ£€æµ‹åˆ°éœ€è¦é‡å¹³è¡¡
   â†“
2. æ›´æ–°é›†ç¾¤ä¸´æ—¶è®¾ç½®
   â†“
3. Elasticsearch è‡ªåŠ¨é‡æ–°åˆ†é…åˆ†ç‰‡
   â†“
4. ç›‘æ§é‡å¹³è¡¡è¿›åº¦
   â†“
5. é‡å¹³è¡¡å®Œæˆ
```

### 3. åˆ†ç‰‡ä¼˜åŒ–ç­–ç•¥

#### è§¦å‘æ¡ä»¶

**ç®—æ³•**ï¼š`hasHotShards(stats)`

```go
func (sc *ShardController) hasHotShards(stats map[string]interface{}) bool {
    // æ£€æµ‹çƒ­ç‚¹åˆ†ç‰‡ï¼š
    // - æŸ¥è¯¢ç‡å¼‚å¸¸é«˜çš„åˆ†ç‰‡
    // - èµ„æºä½¿ç”¨ä¸æˆæ¯”ä¾‹çš„åˆ†ç‰‡
    // - å“åº”æ—¶é—´è¿‡é•¿çš„åˆ†ç‰‡
    return false  // å½“å‰ä¸ºç¤ºä¾‹å®ç°
}
```

**æ£€æµ‹æŒ‡æ ‡**ï¼š
1. ğŸ”¥ åˆ†ç‰‡æŸ¥è¯¢ç‡ï¼ˆQPSï¼‰
2. ğŸ”¥ CPUä½¿ç”¨ç‡
3. ğŸ”¥ å†…å­˜ä½¿ç”¨ç‡
4. ğŸ”¥ ç£ç›˜I/O
5. ğŸ”¥ å“åº”å»¶è¿Ÿ

#### ä¼˜åŒ–é…ç½®

**æ ¸å¿ƒè®¾ç½®**ï¼š

```go
settings := map[string]interface{}{
    "transient": map[string]interface{}{
        "cluster.routing.allocation.balance.shard": 0.45,
        "cluster.routing.allocation.balance.index": 0.55,
        "cluster.routing.allocation.balance.threshold": 1.0,
    },
}
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `cluster.routing.allocation.balance.shard` | `0.45` | åˆ†ç‰‡çº§åˆ«å¹³è¡¡æƒé‡ |
| `cluster.routing.allocation.balance.index` | `0.55` | ç´¢å¼•çº§åˆ«å¹³è¡¡æƒé‡ |
| `cluster.routing.allocation.balance.threshold` | `1.0` | å¹³è¡¡é˜ˆå€¼ |

**ä¼˜åŒ–ç›®æ ‡**ï¼š
- å¹³è¡¡åˆ†ç‰‡åœ¨èŠ‚ç‚¹é—´çš„åˆ†å¸ƒ
- ä¼˜åŒ–ç´¢å¼•çš„åˆ†ç‰‡åˆ†é…
- å‡å°‘çƒ­ç‚¹åˆ†ç‰‡çš„å½±å“
- æå‡æ•´ä½“æŸ¥è¯¢æ€§èƒ½

### 4. è·å–é›†ç¾¤çŠ¶æ€

**æ–¹æ³•**ï¼š`getClusterStats()`

```go
func (sc *ShardController) getClusterStats() (map[string]interface{}, error) {
    // è°ƒç”¨ Elasticsearch API: GET /_cluster/stats
    stats := map[string]interface{}{
        "nodes": map[string]interface{}{
            "count": 3,  // èŠ‚ç‚¹æ•°é‡
        },
        "indices": map[string]interface{}{
            "shards": map[string]interface{}{
                "total": 12,  // æ€»åˆ†ç‰‡æ•°
            },
        },
    }
    return stats, nil
}
```

**å®é™…APIè°ƒç”¨**ï¼š

```bash
GET /_cluster/stats
```

**è¿”å›æ•°æ®ç¤ºä¾‹**ï¼š

```json
{
  "nodes": {
    "count": {
      "total": 3,
      "data": 3,
      "master": 1
    }
  },
  "indices": {
    "count": 5,
    "shards": {
      "total": 12,
      "primaries": 6,
      "replication": 1.0
    }
  }
}
```

## API æ¥å£

### 1. è·å–åˆ†ç‰‡ä¿¡æ¯

**ç«¯ç‚¹**ï¼š`GET /shards`

**ç¤ºä¾‹**ï¼š

```bash
curl -X GET http://localhost:8080/shards
```

**å“åº”**ï¼š

```json
{
  "nodes": {
    "count": 3
  },
  "indices": {
    "shards": {
      "total": 12
    }
  }
}
```

### 2. æ‰‹åŠ¨è§¦å‘é‡å¹³è¡¡

**ç«¯ç‚¹**ï¼š`POST /shards`

**è¯·æ±‚ä½“**ï¼š

```json
{
  "action": "rebalance"
}
```

**ç¤ºä¾‹**ï¼š

```bash
curl -X POST http://localhost:8080/shards \
  -H "Content-Type: application/json" \
  -d '{"action": "rebalance"}'
```

**å“åº”**ï¼š

```
Shard rebalancing triggered
```

### 3. æ‰‹åŠ¨è§¦å‘ä¼˜åŒ–

**ç«¯ç‚¹**ï¼š`POST /shards`

**è¯·æ±‚ä½“**ï¼š

```json
{
  "action": "optimize"
}
```

**ç¤ºä¾‹**ï¼š

```bash
curl -X POST http://localhost:8080/shards \
  -H "Content-Type: application/json" \
  -d '{"action": "optimize"}'
```

**å“åº”**ï¼š

```
Shard allocation optimized
```

## ä½¿ç”¨è„šæœ¬å·¥å…·

### 1. æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

```bash
./scripts/shard-management.sh

# ä½¿ç”¨å‡½æ•°
NAMESPACE=my-cluster get_cluster_state
```

### 2. æŸ¥çœ‹åˆ†ç‰‡åˆ†å¸ƒ

```bash
NAMESPACE=my-cluster get_shard_allocation
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
index  shard  prirep  state    docs  store  ip          node
test   0      p       STARTED  1000  2.5mb  10.0.1.10   node-1
test   0      r       STARTED  1000  2.5mb  10.0.1.11   node-2
test   1      p       STARTED  1200  3.1mb  10.0.1.11   node-2
test   1      r       STARTED  1200  3.1mb  10.0.1.12   node-3
```

### 3. æ‰‹åŠ¨è§¦å‘é‡å¹³è¡¡

```bash
NAMESPACE=my-cluster rebalance_shards
```

### 4. ä¼˜åŒ–åˆ†ç‰‡åˆ†é…

```bash
NAMESPACE=my-cluster optimize_allocation
```

## å®Œæ•´çš„åˆ†ç‰‡ç®¡ç†æµç¨‹

### è‡ªåŠ¨åŒ–æµç¨‹

```mermaid
graph TD
    A[å¯åŠ¨ShardController] --> B[æ¯30ç§’æ‰§è¡Œæ£€æŸ¥]
    B --> C{è·å–é›†ç¾¤çŠ¶æ€}
    C --> D{éœ€è¦é‡å¹³è¡¡?}
    D -->|æ˜¯| E[æ‰§è¡Œé‡å¹³è¡¡]
    D -->|å¦| F{æœ‰çƒ­ç‚¹åˆ†ç‰‡?}
    F -->|æ˜¯| G[ä¼˜åŒ–åˆ†ç‰‡åˆ†é…]
    F -->|å¦| B
    E --> B
    G --> B
```

### æ‰‹åŠ¨ç®¡ç†æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B{è¯·æ±‚ç±»å‹}
    B -->|GET /shards| C[è¿”å›åˆ†ç‰‡ä¿¡æ¯]
    B -->|POST /shards action=rebalance| D[è§¦å‘é‡å¹³è¡¡]
    B -->|POST /shards action=optimize| E[è§¦å‘ä¼˜åŒ–]
    D --> F[è¿”å›æˆåŠŸå“åº”]
    E --> F
    C --> F
```

## ä»£ç ä½ç½®æ€»ç»“

### æ ¸å¿ƒæ–‡ä»¶

1. **`/server/shard_controller.go`** - åˆ†ç‰‡æ§åˆ¶å™¨ä¸»å®ç°
   - Line 11-14: ShardController ç»“æ„ä½“å®šä¹‰
   - Line 25-31: è‡ªåŠ¨ç›‘æ§å¯åŠ¨
   - Line 39-56: åˆ†ç‰‡ç®¡ç†ä¸»é€»è¾‘
   - Line 76-96: é‡å¹³è¡¡å†³ç­–ç®—æ³•
   - Line 99-103: çƒ­ç‚¹åˆ†ç‰‡æ£€æµ‹
   - Line 106-120: é‡å¹³è¡¡æ‰§è¡Œ
   - Line 123-137: ä¼˜åŒ–æ‰§è¡Œ
   - Line 140-189: API æ¥å£å¤„ç†

2. **`/server/main.go`** - æ³¨å†Œåˆ†ç‰‡ç®¡ç†æœåŠ¡
   - Line 868: åˆ›å»ºShardController
   - Line 869: å¯åŠ¨ShardController
   - Line 957: æ³¨å†Œ /shards APIç«¯ç‚¹

3. **`/scripts/shard-management.sh`** - å‘½ä»¤è¡Œå·¥å…·
   - Line 10-13: è·å–é›†ç¾¤çŠ¶æ€
   - Line 16-19: è·å–åˆ†ç‰‡åˆ†å¸ƒ
   - Line 22-34: è§¦å‘é‡å¹³è¡¡
   - Line 37-49: ä¼˜åŒ–åˆ†ç‰‡åˆ†é…

4. **`/demo/shard-demo.sh`** - æ¼”ç¤ºè„šæœ¬
   - å®Œæ•´çš„åˆ†ç‰‡ç®¡ç†åŠŸèƒ½æ¼”ç¤ºæµç¨‹

## æ‰©å±•å»ºè®®

### 1. å¢å¼ºé‡å¹³è¡¡ç­–ç•¥

å½“å‰å®ç°å¯ä»¥æ‰©å±•ä¸ºæ›´æ™ºèƒ½çš„ç­–ç•¥ï¼š

```go
// å¢å¼ºçš„é‡å¹³è¡¡å†³ç­–
func (sc *ShardController) shouldRebalance(stats map[string]interface{}) bool {
    // 1. æ£€æŸ¥åˆ†ç‰‡åˆ†å¸ƒæ–¹å·®
    variance := sc.calculateShardVariance(stats)
    if variance > threshold {
        return true
    }
    
    // 2. æ£€æŸ¥èŠ‚ç‚¹ç£ç›˜ä½¿ç”¨ç‡å·®å¼‚
    diskImbalance := sc.checkDiskImbalance(stats)
    if diskImbalance > 20% {
        return true
    }
    
    // 3. æ£€æŸ¥æ˜¯å¦æœ‰æ–°èŠ‚ç‚¹åŠ å…¥
    if sc.hasNewNodes(stats) {
        return true
    }
    
    return false
}
```

### 2. å®ç°çƒ­ç‚¹åˆ†ç‰‡æ£€æµ‹

```go
// å®é™…çš„çƒ­ç‚¹åˆ†ç‰‡æ£€æµ‹
func (sc *ShardController) hasHotShards(stats map[string]interface{}) bool {
    // è·å–æ¯ä¸ªåˆ†ç‰‡çš„QPS
    shardQPS := sc.getShardQPS()
    
    // è®¡ç®—å¹³å‡QPS
    avgQPS := sc.calculateAverageQPS(shardQPS)
    
    // æ£€æµ‹æ˜¯å¦æœ‰åˆ†ç‰‡QPSè¶…è¿‡å¹³å‡å€¼çš„2å€
    for _, qps := range shardQPS {
        if qps > avgQPS * 2 {
            return true
        }
    }
    
    return false
}
```

### 3. æ·»åŠ åˆ†ç‰‡åˆ†é…è¿‡æ»¤å™¨

```go
// åŸºäºæ ‡ç­¾çš„åˆ†ç‰‡åˆ†é…
settings := map[string]interface{}{
    "transient": map[string]interface{}{
        "cluster.routing.allocation.awareness.attributes": "zone",
        "cluster.routing.allocation.awareness.force.zone.values": "zone1,zone2,zone3",
    },
}
```

### 4. å®ç°åˆ†ç‰‡åˆ†é…ç­–ç•¥æ¨¡æ¿

```go
// åˆ†ç‰‡åˆ†é…ç­–ç•¥é…ç½®
type ShardAllocationPolicy struct {
    RebalanceThreshold      float64
    MaxShardsPerNode        int
    MinShardsPerNode        int
    EnableAutoRebalance     bool
    RebalanceCooldownPeriod time.Duration
}
```

## ç›‘æ§å’Œè°ƒè¯•

### 1. æŸ¥çœ‹å®æ—¶åˆ†ç‰‡çŠ¶æ€

```bash
# é€šè¿‡Elasticsearch API
curl -s http://localhost:9200/_cat/shards?v

# é€šè¿‡Manager API
curl -s http://localhost:8080/shards | jq .
```

### 2. æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€

```bash
curl -s http://localhost:9200/_cluster/health?pretty
```

### 3. ç›‘æ§é‡å¹³è¡¡è¿›åº¦

```bash
curl -s http://localhost:9200/_cat/recovery?v&active_only=true
```

### 4. æŸ¥çœ‹åˆ†ç‰‡åˆ†é…è§£é‡Š

```bash
curl -s http://localhost:9200/_cluster/allocation/explain?pretty
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è°ƒæ•´å¹¶å‘æ¢å¤æ•°

```go
// é«˜æ€§èƒ½é›†ç¾¤å¯ä»¥å¢åŠ å¹¶å‘æ¢å¤æ•°
"cluster.routing.allocation.node_concurrent_recoveries": 4
```

### 2. è°ƒæ•´æ¢å¤é€Ÿç‡

```go
// åœ¨ä½å³°æœŸå¯ä»¥æé«˜æ¢å¤é€Ÿç‡
"indices.recovery.max_bytes_per_sec": "200mb"
```

### 3. ç¦ç”¨ä¸å¿…è¦çš„é‡å¹³è¡¡

```go
// åœ¨ç»´æŠ¤æœŸé—´ä¸´æ—¶ç¦ç”¨è‡ªåŠ¨é‡å¹³è¡¡
"cluster.routing.rebalance.enable": "none"
```

## æ€»ç»“

ES Serverlessçš„åˆ†ç‰‡ç­–ç•¥å®ç°ä½äºä»¥ä¸‹ä½ç½®ï¼š

ğŸ“‚ **æ ¸å¿ƒä»£ç **ï¼š`/server/shard_controller.go`  
ğŸ“‚ **ç®¡ç†è„šæœ¬**ï¼š`/scripts/shard-management.sh`  
ğŸ“‚ **æ¼”ç¤ºè„šæœ¬**ï¼š`/demo/shard-demo.sh`  
ğŸ“‚ **APIæ–‡æ¡£**ï¼š`/docs/api.md`  

**ç‰¹ç‚¹**ï¼š
âœ… è‡ªåŠ¨åŒ–ç›‘æ§ï¼ˆæ¯30ç§’ï¼‰  
âœ… æ™ºèƒ½é‡å¹³è¡¡å†³ç­–  
âœ… çƒ­ç‚¹åˆ†ç‰‡æ£€æµ‹  
âœ… çµæ´»çš„APIæ¥å£  
âœ… å¯é…ç½®çš„ç­–ç•¥å‚æ•°  

é€šè¿‡ShardControllerï¼Œå¹³å°å®ç°äº†å®Œæ•´çš„åˆ†ç‰‡è‡ªåŠ¨åŒ–ç®¡ç†ï¼Œç¡®ä¿é›†ç¾¤æ€§èƒ½å’Œèµ„æºåˆ©ç”¨ç‡çš„æœ€ä¼˜åŒ–ã€‚
