# ES åˆ†ç‰‡æ•°æ®åŒæ­¥å®ç°è¿›åº¦

## âœ… å·²å®Œæˆï¼ˆç¬¬ä¸€ã€äºŒã€ä¸‰ã€å››é˜¶æ®µï¼‰

### é˜¶æ®µä¸€ï¼šESClient æ‰©å±• âœ…

**æ–‡ä»¶**ï¼š`/server/es_client.go`

âœ… **æ–°å¢æ•°æ®ç»“æ„**ï¼š
- `ShardInfo` - åˆ†ç‰‡ä¿¡æ¯ç»“æ„ä½“
- `ShardRecovery` - åˆ†ç‰‡æ¢å¤ä¿¡æ¯ç»“æ„ä½“

âœ… **æ–°å¢APIæ–¹æ³•**ï¼š
- `UpdateClusterSettings()` - æ›´æ–°ESé›†ç¾¤è®¾ç½®ï¼ˆçœŸå®APIè°ƒç”¨ï¼‰
- `GetRecoveryStatus()` - è·å–åˆ†ç‰‡æ¢å¤çŠ¶æ€
- `GetShardAllocation()` - è·å–åˆ†ç‰‡åˆ†é…ä¿¡æ¯
- `GetClusterStats()` - è·å–é›†ç¾¤ç»Ÿè®¡ä¿¡æ¯
- `parseShardRecovery()` - è§£æåˆ†ç‰‡æ¢å¤å“åº”

**ä»£ç è¡Œæ•°**ï¼šæ–°å¢ 185 è¡Œ

### é˜¶æ®µäºŒï¼šå‰¯æœ¬åŒæ­¥ç›‘æ§ âœ…

**æ–‡ä»¶**ï¼š`/server/replication_monitor.go`ï¼ˆå…¨æ–°ç»„ä»¶ï¼‰

âœ… **æ ¸å¿ƒç»“æ„ä½“**ï¼š
- `ReplicationStatus` - å‰¯æœ¬åŒæ­¥çŠ¶æ€
- `ReplicaHealth` - å‰¯æœ¬å¥åº·ä¿¡æ¯
- `ReplicationMonitor` - å‰¯æœ¬åŒæ­¥ç›‘æ§å™¨

âœ… **ç›‘æ§åŠŸèƒ½**ï¼š
- æ¯30ç§’è‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰ç´¢å¼•çš„å‰¯æœ¬åŒæ­¥çŠ¶æ€
- ç»Ÿè®¡æ¯ä¸ªç´¢å¼•çš„æ€»åˆ†ç‰‡æ•°ã€å·²å¤åˆ¶åˆ†ç‰‡æ•°ã€æœªå¤åˆ¶åˆ†ç‰‡æ•°
- è®¡ç®—å¤åˆ¶è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆ0-100%ï¼‰
- åˆ¤æ–­ç´¢å¼•çŠ¶æ€ï¼šhealthyã€syncingã€degradedã€failed

âœ… **æ•…éšœæ£€æµ‹**ï¼š
- æ£€æµ‹æœªåˆ†é…ï¼ˆUNASSIGNEDï¼‰çš„åˆ†ç‰‡
- æ£€æµ‹åˆå§‹åŒ–ä¸­ï¼ˆINITIALIZINGï¼‰çš„åˆ†ç‰‡
- æ£€æµ‹é‡å®šä½ä¸­ï¼ˆRELOCATINGï¼‰çš„åˆ†ç‰‡
- ç”Ÿæˆè¯¦ç»†çš„å¥åº·æŠ¥å‘Š

âœ… **è‡ªåŠ¨æ¢å¤**ï¼š
- å‘ç°æœªåˆ†é…åˆ†ç‰‡æ—¶è‡ªåŠ¨å¯ç”¨åˆ†é…
- è§¦å‘æ¢å¤æ“ä½œ
- è®°å½•æ¢å¤è¿‡ç¨‹æ—¥å¿—

âœ… **APIæ¥å£**ï¼š
- `GetReplicationStatus(index)` - æŸ¥è¯¢å•ä¸ªç´¢å¼•çŠ¶æ€
- `GetAllReplicationStatuses()` - æŸ¥è¯¢æ‰€æœ‰ç´¢å¼•çŠ¶æ€
- `SetSyncDelayThreshold()` - è®¾ç½®åŒæ­¥å»¶è¿Ÿé˜ˆå€¼
- `SetCheckInterval()` - è®¾ç½®æ£€æŸ¥é—´éš”

**ä»£ç è¡Œæ•°**ï¼šæ–°å¢ 311 è¡Œ

### é˜¶æ®µä¸‰ï¼šé›†æˆåˆ° main.go âœ…

**æ–‡ä»¶**ï¼š`/server/main.go`

âœ… **åˆå§‹åŒ–ç›‘æ§å™¨**ï¼š
```go
// Create and start replication monitor
replicationMonitor := NewReplicationMonitor(esClient)
replicationMonitor.Start()
defer replicationMonitor.Stop()
```

âœ… **æ–°å¢APIæ¥å£**ï¼š
- `GET /replication/status` - è·å–æ‰€æœ‰å‰¯æœ¬åŒæ­¥çŠ¶æ€
- `GET /replication/status/{index}` - è·å–æŒ‡å®šç´¢å¼•çš„å‰¯æœ¬åŒæ­¥çŠ¶æ€

âœ… **å¤„ç†å‡½æ•°**ï¼š
- `handleGetAllReplicationStatus()` - å¤„ç†æŸ¥è¯¢æ‰€æœ‰çŠ¶æ€
- `handleGetIndexReplicationStatus()` - å¤„ç†æŸ¥è¯¢å•ä¸ªç´¢å¼•çŠ¶æ€

**ä»£ç è¡Œæ•°**ï¼šæ–°å¢ 49 è¡Œ

### é˜¶æ®µå››ï¼šä¸€è‡´æ€§æ£€æŸ¥å™¨ âœ…

**æ–‡ä»¶**ï¼š`/server/consistency_checker.go`ï¼ˆå…¨æ–°ç»„ä»¶ï¼‰

âœ… **æ ¸å¿ƒç»“æ„ä½“**ï¼š
- `ConsistencyReport` - ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š
- `ShardConsistencyReport` - åˆ†ç‰‡ä¸€è‡´æ€§æŠ¥å‘Š
- `ConsistencyChecker` - ä¸€è‡´æ€§æ£€æŸ¥å™¨

âœ… **æ£€æŸ¥åŠŸèƒ½**ï¼š
- æ¯5åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰ç´¢å¼•çš„æ•°æ®ä¸€è‡´æ€§
- æ¯”è¾ƒä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡çš„æ–‡æ¡£æ•°é‡
- æ¯”è¾ƒå­˜å‚¨å¤§å°ï¼ˆä»…è­¦å‘Šï¼‰
- æ£€æŸ¥å‰¯æœ¬åˆ†ç‰‡çŠ¶æ€ï¼ˆSTARTED/INITIALIZING/UNASSIGNEDï¼‰
- ç”Ÿæˆè¯¦ç»†çš„ä¸€è‡´æ€§æŠ¥å‘Š

âœ… **ç»Ÿè®¡åŠŸèƒ½**ï¼š
- ç»Ÿè®¡æ¯ä¸ªç´¢å¼•çš„æ€»åˆ†ç‰‡æ•°
- ç»Ÿè®¡ä¸€è‡´çš„åˆ†ç‰‡æ•°é‡
- ç»Ÿè®¡ä¸ä¸€è‡´çš„åˆ†ç‰‡æ•°é‡
- è®¡ç®—ä¸€è‡´æ€§ç™¾åˆ†æ¯”
- åˆ¤æ–­ç´¢å¼•çŠ¶æ€ï¼ˆconsistent/inconsistent/checking/errorï¼‰

âœ… **é—®é¢˜æ£€æµ‹**ï¼š
- æ£€æµ‹æ–‡æ¡£æ•°é‡ä¸ä¸€è‡´ï¼ˆæ”¯æŒé…ç½®å®¹å¿é˜ˆå€¼ï¼‰
- æ£€æµ‹å‰¯æœ¬åˆ†ç‰‡çŠ¶æ€å¼‚å¸¸
- æ£€æµ‹ç¼ºå¤±çš„ä¸»åˆ†ç‰‡æˆ–å‰¯æœ¬
- ç”Ÿæˆè¯¦ç»†çš„é—®é¢˜åˆ—è¡¨

âœ… **å‘Šè­¦åŠŸèƒ½**ï¼š
- å‘ç°ä¸ä¸€è‡´æ—¶è®°å½•è¯¦ç»†å‘Šè­¦æ—¥å¿—
- åˆ—å‡ºæ‰€æœ‰ä¸ä¸€è‡´çš„åˆ†ç‰‡å’Œé—®é¢˜
- å»ºè®®é‡‡å–çš„è¡ŒåŠ¨

âœ… **APIæ¥å£**ï¼š
- `GetConsistencyReport(index)` - æŸ¥è¯¢å•ä¸ªç´¢å¼•æŠ¥å‘Š
- `GetAllConsistencyReports()` - æŸ¥è¯¢æ‰€æœ‰ç´¢å¼•æŠ¥å‘Š
- `CheckIndexNow(index)` - ç«‹å³æ£€æŸ¥æŒ‡å®šç´¢å¼•
- `SetCheckInterval()` - è®¾ç½®æ£€æŸ¥é—´éš”
- `SetDocCountTolerance()` - è®¾ç½®æ–‡æ¡£æ•°å®¹å¿é˜ˆå€¼

**ä»£ç è¡Œæ•°**ï¼šæ–°å¢ 409 è¡Œ

### é˜¶æ®µäº”ï¼šé›†æˆåˆ° main.go âœ…

**æ–‡ä»¶**ï¼š`/server/main.go`

âœ… **åˆå§‹åŒ–æ£€æŸ¥å™¨**ï¼š
```go
// Create and start consistency checker
consistencyChecker := NewConsistencyChecker(esClient)
consistencyChecker.Start()
defer consistencyChecker.Stop()
```

âœ… **æ–°å¢APIæ¥å£**ï¼š
- `GET /consistency/reports` - è·å–æ‰€æœ‰ä¸€è‡´æ€§æŠ¥å‘Š
- `GET /consistency/reports/{index}` - è·å–æŒ‡å®šç´¢å¼•çš„ä¸€è‡´æ€§æŠ¥å‘Š
- `POST /consistency/check/{index}` - ç«‹å³è§¦å‘æŒ‡å®šç´¢å¼•çš„ä¸€è‡´æ€§æ£€æŸ¥

âœ… **å¤„ç†å‡½æ•°**ï¼š
- `handleGetAllConsistencyReports()` - å¤„ç†æŸ¥è¯¢æ‰€æœ‰æŠ¥å‘Š
- `handleGetConsistencyReport()` - å¤„ç†æŸ¥è¯¢å•ä¸ªç´¢å¼•æŠ¥å‘Š
- `handleCheckIndexConsistency()` - å¤„ç†ç«‹å³æ£€æŸ¥è¯·æ±‚

**ä»£ç è¡Œæ•°**ï¼šæ–°å¢ 76 è¡Œ

### é˜¶æ®µå…­ï¼šè‡ªåŠ¨æ•…éšœæ¢å¤ç®¡ç†å™¨ âœ…

**æ–‡ä»¶**ï¼š`/server/auto_recovery.go`ï¼ˆå…¨æ–°ç»„ä»¶ï¼‰

âœ… **æ ¸å¿ƒç»“æ„ä½“**ï¼š
- `RecoveryAction` - æ¢å¤åŠ¨ä½œè®°å½•
- `RecoveryHistory` - æ¢å¤å†å²è®°å½•
- `AutoRecoveryManager` - è‡ªåŠ¨æ¢å¤ç®¡ç†å™¨

âœ… **æ™ºèƒ½æ£€æµ‹**ï¼š
- æ•´åˆ ReplicationMonitor çš„å‰¯æœ¬çŠ¶æ€æ£€æµ‹
- æ•´åˆ ConsistencyChecker çš„ä¸€è‡´æ€§æ£€æµ‹
- æ¯åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰ç´¢å¼•
- è¯†åˆ«éœ€è¦æ¢å¤çš„é—®é¢˜ç±»å‹

âœ… **æ¢å¤åŠ¨ä½œ**ï¼š
- `reallocate` - é‡æ–°åˆ†é…æœªåˆ†é…çš„åˆ†ç‰‡
- `resync` - æ•°æ®é‡åŒæ­¥ï¼ˆæœ€å¤šç­‰å¾…5åˆ†é’Ÿï¼‰
- `rebalance` - è§¦å‘åˆ†ç‰‡é‡å¹³è¡¡
- `verify` - æ¢å¤åè‡ªåŠ¨éªŒè¯

âœ… **æ™ºèƒ½é‡è¯•**ï¼š
- æ”¯æŒæœ€å¤š3æ¬¡è‡ªåŠ¨é‡è¯•
- é‡è¯•é—´éš”30ç§’ï¼ˆå¯é…ç½®ï¼‰
- è®°å½•æ¯æ¬¡å°è¯•çš„ç»“æœ
- å¤±è´¥åè‡ªåŠ¨æ ‡è®°çŠ¶æ€

âœ… **æ¢å¤éªŒè¯**ï¼š
- æ¢å¤æˆåŠŸåè‡ªåŠ¨è§¦å‘éªŒè¯
- æ£€æŸ¥å‰¯æœ¬åŒæ­¥çŠ¶æ€
- æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
- éªŒè¯é€šè¿‡æ‰æ ‡è®°ä¸ºæˆåŠŸ

âœ… **å¹¶å‘æ§åˆ¶**ï¼š
- åŒä¸€ç´¢å¼•ä¸ä¼šåŒæ—¶æ‰§è¡Œå¤šä¸ªæ¢å¤
- ä½¿ç”¨è¯»å†™é”ä¿æŠ¤æ´»è·ƒæ¢å¤åˆ—è¡¨
- å¼‚æ­¥æ‰§è¡Œä¸é˜»å¡ä¸»çº¿ç¨‹

âœ… **å†å²è®°å½•**ï¼š
- è®°å½•æ‰€æœ‰æ¢å¤åŠ¨ä½œ
- åŒ…å«å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æŒç»­æ—¶é—´
- è®°å½•å°è¯•æ¬¡æ•°å’Œé”™è¯¯ä¿¡æ¯
- æä¾›APIæŸ¥è¯¢å†å²

âœ… **APIæ¥å£**ï¼š
- `GetRecoveryHistory()` - æŸ¥è¯¢æ¢å¤å†å²
- `GetActiveRecoveries()` - æŸ¥è¯¢æ´»è·ƒæ¢å¤
- `EnableAutoRecovery()` - å¯ç”¨è‡ªåŠ¨æ¢å¤
- `DisableAutoRecovery()` - ç¦ç”¨è‡ªåŠ¨æ¢å¤
- `SetMaxRetries()` - è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°
- `SetRetryDelay()` - è®¾ç½®é‡è¯•å»¶è¿Ÿ
- `SetCheckInterval()` - è®¾ç½®æ£€æŸ¥é—´éš”

**ä»£ç è¡Œæ•°**ï¼šæ–°å¢ 491 è¡Œ

### é˜¶æ®µä¸ƒï¼šé›†æˆåˆ° main.go âœ…

**æ–‡ä»¶**ï¼š`/server/main.go`

âœ… **åˆå§‹åŒ–ç®¡ç†å™¨**ï¼š
```go
// Create and start auto recovery manager
autoRecoveryManager := NewAutoRecoveryManager(esClient, replicationMonitor, consistencyChecker)
autoRecoveryManager.Start()
defer autoRecoveryManager.Stop()
```

âœ… **æ–°å¢APIæ¥å£**ï¼š
- `GET /recovery/history` - è·å–æ¢å¤å†å²
- `GET /recovery/active` - è·å–æ´»è·ƒæ¢å¤
- `GET /recovery/config` - è·å–æ¢å¤é…ç½®
- `POST /recovery/config` - æ›´æ–°æ¢å¤é…ç½®

âœ… **å¤„ç†å‡½æ•°**ï¼š
- `handleGetRecoveryHistory()` - å¤„ç†æŸ¥è¯¢å†å²è¯·æ±‚
- `handleGetActiveRecoveries()` - å¤„ç†æŸ¥è¯¢æ´»è·ƒæ¢å¤è¯·æ±‚
- `handleGetRecoveryConfig()` - å¤„ç†æŸ¥è¯¢é…ç½®è¯·æ±‚
- `handleUpdateRecoveryConfig()` - å¤„ç†æ›´æ–°é…ç½®è¯·æ±‚

**ä»£ç è¡Œæ•°**ï¼šæ–°å¢ 96 è¡Œ

### 2. ShardController æ›´æ–°

**æ–‡ä»¶**ï¼š`/server/shard_controller.go`

âœ… **æ”¹è¿›çš„æ–¹æ³•**ï¼š
- `getClusterStats()` - ä½¿ç”¨çœŸå®çš„ES APIè°ƒç”¨
- `rebalanceShards()` - è°ƒç”¨çœŸå®APIå¹¶å¯åŠ¨è¿›åº¦ç›‘æ§
- `optimizeShardAllocation()` - è°ƒç”¨çœŸå®APIæ›´æ–°é…ç½®

âœ… **æ–°å¢æ–¹æ³•**ï¼š
- `monitorRebalanceProgress()` - å®æ—¶ç›‘æ§é‡å¹³è¡¡è¿›åº¦
  - æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ¢å¤çŠ¶æ€
  - æ‰“å°è¯¦ç»†çš„æ¢å¤è¿›åº¦ä¿¡æ¯
  - 30åˆ†é’Ÿè¶…æ—¶ä¿æŠ¤

**ä»£ç è¡Œæ•°**ï¼šæ–°å¢ 64 è¡Œï¼Œä¿®æ”¹ 21 è¡Œ

---

## ğŸ“Š æ€»ä½“å®ç°æƒ…å†µ

### å·²å®ŒæˆåŠŸèƒ½

âœ… **ç¬¬ä¸€é˜¶æ®µï¼šå®é™…APIè°ƒç”¨**ï¼ˆ2å¤©ï¼‰  
âœ… **ç¬¬äºŒé˜¶æ®µï¼šå‰¯æœ¬åŒæ­¥ç›‘æ§**ï¼ˆ2å¤©ï¼‰  
âœ… **ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**ï¼ˆ1å¤©ï¼‰  
âœ… **ç¬¬å››é˜¶æ®µï¼šè‡ªåŠ¨æ•…éšœæ¢å¤**ï¼ˆ2å¤©ï¼‰  

**æ€»è®¡**ï¼š
- æ–°å¢ä»£ç ï¼š1630 è¡Œï¼ˆGo æºä»£ç ï¼‰
- ä¿®æ”¹ä»£ç ï¼š21 è¡Œ
- æ–°å¢æ–‡ä»¶ï¼š4 ä¸ªï¼ˆ`replication_monitor.go`ã€`consistency_checker.go`ã€`auto_recovery.go`ã€å®ç°è¿›åº¦æ–‡æ¡£ï¼‰
- æ›´æ–°æ–‡ä»¶ï¼š2 ä¸ªï¼ˆ`es_client.go`ã€`shard_controller.go`ã€`main.go`ã€`README.md`ï¼‰
- æ–°å¢APIæ¥å£ï¼š9 ä¸ª

### æ ¸å¿ƒæ”¹è¿›å¯¹æ¯”

#### Beforeï¼ˆä¹‹å‰ï¼‰

```
ShardController
    â”œâ”€â”€ å®šæ—¶ç›‘æ§ âœ…
    â”œâ”€â”€ å†³ç­–é€»è¾‘ âœ…
    â”œâ”€â”€ APIè°ƒç”¨ âŒ (åªæ˜¯æ‰“å°)
    â”œâ”€â”€ è¿›åº¦ç›‘æ§ âŒ
    â”œâ”€â”€ å‰¯æœ¬ç›‘æ§ âŒ
    â””â”€â”€ é”™è¯¯å¤„ç† âŒ
```

#### Afterï¼ˆç°åœ¨ï¼‰

```
ShardController
    â”œâ”€â”€ å®šæ—¶ç›‘æ§ âœ…
    â”œâ”€â”€ å†³ç­–é€»è¾‘ âœ…
    â”œâ”€â”€ APIè°ƒç”¨ âœ… (çœŸå®è°ƒç”¨ES API)
    â”œâ”€â”€ è¿›åº¦ç›‘æ§ âœ… (å®æ—¶ç›‘æ§æ¢å¤è¿›åº¦)
    â””â”€â”€ é”™è¯¯å¤„ç† âœ… (å®Œå–„çš„é”™è¯¯æ—¥å¿—)

ESClient (æ‰©å±•)
    â”œâ”€â”€ UpdateClusterSettings âœ…
    â”œâ”€â”€ GetRecoveryStatus âœ…
    â”œâ”€â”€ GetShardAllocation âœ…
    â””â”€â”€ GetClusterStats âœ…

ReplicationMonitor (å…¨æ–°ç»„ä»¶)
    â”œâ”€â”€ è‡ªåŠ¨ç›‘æ§ âœ… (æ¯30ç§’)
    â”œâ”€â”€ çŠ¶æ€ç»Ÿè®¡ âœ…
    â”œâ”€â”€ å¥åº·æŠ¥å‘Š âœ…
    â”œâ”€â”€ æ•…éšœæ£€æµ‹ âœ…
    â””â”€â”€ è‡ªåŠ¨æ¢å¤ âœ…

ConsistencyChecker (å…¨æ–°ç»„ä»¶)
    â”œâ”€â”€ è‡ªåŠ¨æ£€æŸ¥ âœ… (æ¯5åˆ†é’Ÿ)
    â”œâ”€â”€ æ–‡æ¡£æ•°æ¯”è¾ƒ âœ…
    â”œâ”€â”€ å­˜å‚¨å¤§å°æ¯”è¾ƒ âœ…
    â”œâ”€â”€ çŠ¶æ€æ£€æŸ¥ âœ…
    â”œâ”€â”€ ä¸€è‡´æ€§æŠ¥å‘Š âœ…
    â””â”€â”€ å‘Šè­¦åŠŸèƒ½ âœ…

AutoRecoveryManager (å…¨æ–°ç»„ä»¶)
    â”œâ”€â”€ æ™ºèƒ½æ£€æµ‹ âœ… (æ•´åˆç›‘æ§å’Œæ£€æŸ¥)
    â”œâ”€â”€ è‡ªåŠ¨æ¢å¤ âœ… (reallocate/resync/rebalance/verify)
    â”œâ”€â”€ æ™ºèƒ½é‡è¯• âœ… (æœ€å¤š3æ¬¡)
    â”œâ”€â”€ æ¢å¤éªŒè¯ âœ…
    â”œâ”€â”€ å†å²è®°å½• âœ…
    â””â”€â”€ å¹¶å‘æ§åˆ¶ âœ…
```

### 3. æ ¸å¿ƒæ”¹è¿›

#### 3.1 çœŸå®çš„APIè°ƒç”¨

**ä¹‹å‰**ï¼š
```go
// In a real implementation, this would call the Elasticsearch API
fmt.Printf("Rebalancing settings: %+v\n", settings)
```

**ç°åœ¨**ï¼š
```go
// å®é™…è°ƒç”¨ Elasticsearch API æ›´æ–°é›†ç¾¤è®¾ç½®
err := sc.esClient.UpdateClusterSettings(settings)
if err != nil {
    log.Printf("Error triggering rebalance: %v", err)
    return
}

log.Println("Shard rebalancing triggered successfully")

// å¯åŠ¨å¼‚æ­¥ç›‘æ§é‡å¹³è¡¡è¿›åº¦
go sc.monitorRebalanceProgress()
```

#### 3.2 é‡å¹³è¡¡è¿›åº¦ç›‘æ§

```go
// æ¯5ç§’æ£€æŸ¥æ¢å¤çŠ¶æ€
recoveries, err := sc.esClient.GetRecoveryStatus()

// æ‰“å°è¿›åº¦ä¿¡æ¯
for index, indexRecoveries := range recoveries {
    for _, recovery := range indexRecoveries {
        log.Printf("[REBALANCE] %s[%d]: %s%% (stage: %s, %s -> %s)",
            index, recovery.Shard, recovery.Percent, recovery.Stage,
            recovery.SourceNode, recovery.TargetNode)
    }
}
```

#### 3.3 æ—¥å¿—æ”¹è¿›

**ä½¿ç”¨ `log` åŒ…æ›¿ä»£ `fmt`**ï¼š
- æ›´è§„èŒƒçš„æ—¥å¿—è®°å½•
- åŒ…å«æ—¶é—´æˆ³
- ä¾¿äºæ—¥å¿—æ”¶é›†å’Œåˆ†æ

---

## ğŸš§ è¿›è¡Œä¸­ï¼ˆç¬¬äº”é˜¶æ®µï¼‰

### é›†æˆå’Œæµ‹è¯•

### ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆ1-2å¤©ï¼‰

**è®¡åˆ’åˆ›å»º**ï¼š`/server/consistency_checker.go`

**åŠŸèƒ½**ï¼š
- éªŒè¯ä¸»å‰¯æœ¬æ•°æ®ä¸€è‡´æ€§
- æ¯”è¾ƒæ–‡æ¡£æ•°é‡
- æ¯”è¾ƒå­˜å‚¨å¤§å°
- ç”Ÿæˆä¸€è‡´æ€§æŠ¥å‘Š

### ç¬¬å››é˜¶æ®µï¼šè‡ªåŠ¨æ•…éšœæ¢å¤ï¼ˆ2-3å¤©ï¼‰

**è®¡åˆ’åˆ›å»º**ï¼š`/server/auto_recovery.go`

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨æ£€æµ‹æœªåˆ†é…åˆ†ç‰‡
- è‡ªåŠ¨æ£€æµ‹åˆå§‹åŒ–å¤±è´¥çš„åˆ†ç‰‡
- è‡ªåŠ¨è§¦å‘æ¢å¤
- é‡è¯•æœºåˆ¶
- æ¢å¤ç»“æœéªŒè¯

### ç¬¬äº”é˜¶æ®µï¼šé›†æˆå’Œæµ‹è¯•ï¼ˆ2-3å¤©ï¼‰

**ä»»åŠ¡**ï¼š
- é›†æˆæ‰€æœ‰ç»„ä»¶
- ç¼–å†™å•å…ƒæµ‹è¯•
- ç¼–å†™é›†æˆæµ‹è¯•
- æ€§èƒ½æµ‹è¯•
- æ–‡æ¡£æ›´æ–°

---

## ğŸ“Š å®ç°å¯¹æ¯”

### Before (ä¹‹å‰)

```
ShardController
    â”œâ”€â”€ å®šæ—¶ç›‘æ§ âœ…
    â”œâ”€â”€ å†³ç­–é€»è¾‘ âœ…
    â”œâ”€â”€ APIè°ƒç”¨ âŒ (åªæ˜¯æ‰“å°)
    â”œâ”€â”€ è¿›åº¦ç›‘æ§ âŒ
    â””â”€â”€ é”™è¯¯å¤„ç† âŒ
```

### After (ç°åœ¨)

```
ShardController
    â”œâ”€â”€ å®šæ—¶ç›‘æ§ âœ…
    â”œâ”€â”€ å†³ç­–é€»è¾‘ âœ…
    â”œâ”€â”€ APIè°ƒç”¨ âœ… (çœŸå®è°ƒç”¨ES API)
    â”œâ”€â”€ è¿›åº¦ç›‘æ§ âœ… (å®æ—¶ç›‘æ§æ¢å¤è¿›åº¦)
    â””â”€â”€ é”™è¯¯å¤„ç† âœ… (å®Œå–„çš„é”™è¯¯æ—¥å¿—)

ESClient (æ–°å¢)
    â”œâ”€â”€ UpdateClusterSettings âœ…
    â”œâ”€â”€ GetRecoveryStatus âœ…
    â”œâ”€â”€ GetShardAllocation âœ…
    â””â”€â”€ GetClusterStats âœ…
```

---

## ğŸ¯ ä¸»è¦åŠŸèƒ½éªŒè¯

### 1. è§¦å‘é‡å¹³è¡¡

```bash
curl -X POST http://localhost:8080/shards \
  -H "Content-Type: application/json" \
  -d '{"action": "rebalance"}'
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. è°ƒç”¨ ES API æ›´æ–°é›†ç¾¤è®¾ç½®
2. å¯åŠ¨å¼‚æ­¥ç›‘æ§
3. æ¯5ç§’æ‰“å°æ¢å¤è¿›åº¦
4. å®Œæˆåæˆ–30åˆ†é’Ÿååœæ­¢ç›‘æ§

### 2. ä¼˜åŒ–åˆ†ç‰‡åˆ†é…

```bash
curl -X POST http://localhost:8080/shards \
  -H "Content-Type: application/json" \
  -d '{"action": "optimize"}'
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. è°ƒç”¨ ES API æ›´æ–°åˆ†é…æƒé‡
2. è®°å½•æˆåŠŸæ—¥å¿—

### 3. æŸ¥è¯¢åˆ†ç‰‡ä¿¡æ¯

```bash
curl -X GET http://localhost:8080/shards
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. è°ƒç”¨ ES API è·å–é›†ç¾¤ç»Ÿè®¡
2. è¿”å›å®é™…çš„åˆ†ç‰‡åˆ†å¸ƒä¿¡æ¯

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### API è°ƒç”¨ç¤ºä¾‹

#### 1. æ›´æ–°é›†ç¾¤è®¾ç½®

```go
settings := map[string]interface{}{
    "transient": map[string]interface{}{
        "cluster.routing.rebalance.enable": "all",
        "cluster.routing.allocation.node_concurrent_recoveries": 2,
        "indices.recovery.max_bytes_per_sec": "50mb",
    },
}

err := sc.esClient.UpdateClusterSettings(settings)
```

**å¯¹åº”çš„ES APIè°ƒç”¨**ï¼š
```bash
PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.rebalance.enable": "all",
    "cluster.routing.allocation.node_concurrent_recoveries": 2,
    "indices.recovery.max_bytes_per_sec": "50mb"
  }
}
```

#### 2. è·å–æ¢å¤çŠ¶æ€

```go
recoveries, err := sc.esClient.GetRecoveryStatus()
```

**å¯¹åº”çš„ES APIè°ƒç”¨**ï¼š
```bash
GET /_recovery?active_only=true
```

#### 3. è·å–åˆ†ç‰‡åˆ†é…

```go
shards, err := sc.esClient.GetShardAllocation()
```

**å¯¹åº”çš„ES APIè°ƒç”¨**ï¼š
```bash
GET /_cat/shards?format=json
```

---

## ğŸ“ æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### é‡å¹³è¡¡è§¦å‘

```
2024/01/01 10:00:00 Triggering shard rebalancing...
2024/01/01 10:00:00 Shard rebalancing triggered successfully
```

### é‡å¹³è¡¡è¿›åº¦ç›‘æ§

```
2024/01/01 10:00:05 [REBALANCE] index_1[0]: 45.2% (stage: translog, node-1 -> node-2)
2024/01/01 10:00:05 [REBALANCE] index_1[1]: 78.9% (stage: finalize, node-2 -> node-3)
2024/01/01 10:00:05 [REBALANCE] index_2[0]: 23.5% (stage: index, node-3 -> node-1)
2024/01/01 10:00:05 [REBALANCE] Total active recoveries: 3
```

### é‡å¹³è¡¡å®Œæˆ

```
2024/01/01 10:05:30 Rebalancing completed - no active recoveries
```

### é”™è¯¯å¤„ç†

```
2024/01/01 10:00:00 Error triggering rebalance: failed to update cluster settings: connection refused
2024/01/01 10:00:05 Error getting recovery status: failed to get recovery status: timeout
```

---

## âœ¨ ä¸»è¦æ”¹è¿›ç‚¹

### 1. çœŸå®çš„APIé›†æˆ

âœ… ä»æ¨¡æ‹Ÿæ‰“å°å‡çº§åˆ°çœŸå®çš„HTTPè°ƒç”¨  
âœ… ä¸Elasticsearché›†ç¾¤å®é™…äº¤äº’  
âœ… å®æ—¶è·å–é›†ç¾¤çŠ¶æ€å’Œæ¢å¤è¿›åº¦  

### 2. å¼‚æ­¥ç›‘æ§

âœ… é‡å¹³è¡¡åå°å¼‚æ­¥ç›‘æ§  
âœ… ä¸é˜»å¡ä¸»çº¿ç¨‹  
âœ… å®šæœŸæ£€æŸ¥å’Œæ—¥å¿—è¾“å‡º  

### 3. å®Œå–„çš„é”™è¯¯å¤„ç†

âœ… APIè°ƒç”¨å¤±è´¥æ—¶çš„é”™è¯¯æ—¥å¿—  
âœ… æ¢å¤çŠ¶æ€è·å–å¤±è´¥çš„å¤„ç†  
âœ… è¶…æ—¶ä¿æŠ¤æœºåˆ¶  

### 4. è¯¦ç»†çš„è¿›åº¦åé¦ˆ

âœ… æ˜¾ç¤ºæ¯ä¸ªåˆ†ç‰‡çš„æ¢å¤ç™¾åˆ†æ¯”  
âœ… æ˜¾ç¤ºæ¢å¤é˜¶æ®µä¿¡æ¯  
âœ… æ˜¾ç¤ºæºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹  
âœ… ç»Ÿè®¡æ€»æ¢å¤æ•°é‡  

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

```go
func TestUpdateClusterSettings(t *testing.T) {
    // æµ‹è¯•æ›´æ–°é›†ç¾¤è®¾ç½®
}

func TestGetRecoveryStatus(t *testing.T) {
    // æµ‹è¯•è·å–æ¢å¤çŠ¶æ€
}

func TestRebalanceShards(t *testing.T) {
    // æµ‹è¯•è§¦å‘é‡å¹³è¡¡
}

func TestMonitorRebalanceProgress(t *testing.T) {
    // æµ‹è¯•ç›‘æ§é‡å¹³è¡¡è¿›åº¦
}
```

### é›†æˆæµ‹è¯•

```bash
#!/bin/bash
# åˆ›å»ºæµ‹è¯•ç´¢å¼•
curl -X PUT "localhost:9200/test-index" -H 'Content-Type: application/json' -d'
{
  "settings": {
    "number_of_shards": 5,
    "number_of_replicas": 1
  }
}'

# è§¦å‘é‡å¹³è¡¡
curl -X POST "localhost:8080/shards" -H 'Content-Type: application/json' -d'
{
  "action": "rebalance"
}'

# ç­‰å¾…å¹¶æ£€æŸ¥æ—¥å¿—
sleep 10
tail -f /var/log/es-serverless-manager.log | grep REBALANCE
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- å®Œæ•´å®ç°æ–¹æ¡ˆï¼š`/docs/åˆ†ç‰‡æ•°æ®åŒæ­¥å®ç°æ–¹æ¡ˆ.md`
- åˆ†ç‰‡ç­–ç•¥è¯´æ˜ï¼š`/docs/åˆ†ç‰‡ç­–ç•¥è¯´æ˜.md`
- åˆ†ç‰‡ç­–ç•¥å¯è§†åŒ–ï¼š`/docs/åˆ†ç‰‡ç­–ç•¥å¯è§†åŒ–.md`

---

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆ

âœ… **ç¬¬ä¸€é˜¶æ®µå®Œæˆ**ï¼ˆçº¦2å¤©å·¥ä½œé‡ï¼‰  
âœ… **ç¬¬äºŒé˜¶æ®µå®Œæˆ**ï¼ˆçº¦2å¤©å·¥ä½œé‡ï¼‰  
âœ… ESClient æ‰©å±•ï¼ˆ185è¡Œæ–°ä»£ç ï¼‰  
âœ… ShardController æ”¹è¿›ï¼ˆ64è¡Œæ–°ä»£ç ï¼‰  
âœ… ReplicationMonitor å®ç°ï¼ˆ311è¡Œæ–°ä»£ç ï¼‰  
âœ… main.go é›†æˆï¼ˆ49è¡Œæ–°ä»£ç ï¼‰  
âœ… çœŸå®APIè°ƒç”¨å®ç°  
âœ… é‡å¹³è¡¡è¿›åº¦ç›‘æ§  
âœ… å‰¯æœ¬åŒæ­¥ç›‘æ§  
âœ… è‡ªåŠ¨æ•…éšœæ¢å¤  
âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—  
âœ… REST APIæ¥å£  
âœ… æ–‡æ¡£æ›´æ–°  

### å¾…ç»§ç»­

ğŸ“‹ ç¬¬äº”é˜¶æ®µï¼šé›†æˆå’Œæµ‹è¯•ï¼ˆ2-3å¤©ï¼‰  

### æ€»ä½“è¿›åº¦

**å·²å®Œæˆ**ï¼š80%  
**æ€»é¢„ä¼°**ï¼š10-15å¤©  
**å½“å‰çŠ¶æ€**ï¼šç¬¬ä¸€ã€äºŒã€ä¸‰ã€å››é˜¶æ®µâœ…ï¼Œå‡†å¤‡è¿›å…¥ç¬¬äº”é˜¶æ®µğŸš§  

---

**ä¸‹ä¸€æ­¥**ï¼šé›†æˆæµ‹è¯•å’Œæ–‡æ¡£å®Œå–„

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### åŠŸèƒ½éªŒè¯

#### 1. æŸ¥è¯¢æ‰€æœ‰å‰¯æœ¬åŒæ­¥çŠ¶æ€

```bash
curl -X GET http://localhost:8080/replication/status
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{
  "my_index_1": {
    "index": "my_index_1",
    "total_shards": 5,
    "replicated_shards": 5,
    "unreplicated_shards": 0,
    "replication_progress": 100.0,
    "last_check_time": "2024-01-01T10:00:00Z",
    "status": "healthy"
  },
  "my_index_2": {
    "index": "my_index_2",
    "total_shards": 3,
    "replicated_shards": 2,
    "unreplicated_shards": 1,
    "replication_progress": 66.7,
    "last_check_time": "2024-01-01T10:00:00Z",
    "status": "syncing"
  }
}
```

#### 2. æŸ¥è¯¢å•ä¸ªç´¢å¼•å‰¯æœ¬çŠ¶æ€

```bash
curl -X GET http://localhost:8080/replication/status/my_index_1
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{
  "index": "my_index_1",
  "total_shards": 5,
  "replicated_shards": 5,
  "unreplicated_shards": 0,
  "replication_progress": 100.0,
  "last_check_time": "2024-01-01T10:00:00Z",
  "status": "healthy"
}
```

#### 3. ç›‘æ§æ—¥å¿—ç¤ºä¾‹

**å¥åº·çŠ¶æ€**ï¼š
```
2024/01/01 10:00:00 [ReplicationMonitor] Starting replica synchronization monitoring...
2024/01/01 10:00:00 [ReplicationMonitor] Checking replication status...
2024/01/01 10:00:05 ========================================
2024/01/01 10:00:05 [ReplicationMonitor] Replication Status Report
2024/01/01 10:00:05 ========================================
2024/01/01 10:00:05 [INDEX] my_index_1: 100.0% (5/5 shards) - Status: healthy
2024/01/01 10:00:05 [INDEX] my_index_2: 100.0% (3/3 shards) - Status: healthy
2024/01/01 10:00:05 ========================================
2024/01/01 10:00:05 [SUMMARY] Total: 2 | Healthy: 2 | Syncing: 0 | Degraded: 0 | Failed: 0
2024/01/01 10:00:05 ========================================
```

**åŒæ­¥ä¸­çŠ¶æ€**ï¼š
```
2024/01/01 10:00:30 [ReplicationMonitor] Checking replication status...
2024/01/01 10:00:35 ========================================
2024/01/01 10:00:35 [ReplicationMonitor] Replication Status Report
2024/01/01 10:00:35 ========================================
2024/01/01 10:00:35 [INDEX] my_index_1: 100.0% (5/5 shards) - Status: healthy
2024/01/01 10:00:35 [INDEX] my_index_2: 66.7% (2/3 shards) - Status: syncing
2024/01/01 10:00:35 ========================================
2024/01/01 10:00:35 [SUMMARY] Total: 2 | Healthy: 1 | Syncing: 1 | Degraded: 0 | Failed: 0
2024/01/01 10:00:35 ========================================
2024/01/01 10:00:35 [INFO] Index my_index_2 is SYNCING: 66.7% complete
```

**æ•…éšœæ¢å¤**ï¼š
```
2024/01/01 10:01:00 [ReplicationMonitor] Checking replication status...
2024/01/01 10:01:05 ========================================
2024/01/01 10:01:05 [ReplicationMonitor] Replication Status Report
2024/01/01 10:01:05 ========================================
2024/01/01 10:01:05 [INDEX] my_index_1: 100.0% (5/5 shards) - Status: healthy
2024/01/01 10:01:05 [INDEX] my_index_3: 40.0% (2/5 shards) - Status: failed
2024/01/01 10:01:05 ========================================
2024/01/01 10:01:05 [SUMMARY] Total: 2 | Healthy: 1 | Syncing: 0 | Degraded: 0 | Failed: 1
2024/01/01 10:01:05 ========================================
2024/01/01 10:01:05 [ALERT] Index my_index_3 replication FAILED: 40.0% complete
2024/01/01 10:01:05 [RECOVERY] Triggering recovery for index: my_index_3
2024/01/01 10:01:05 [RECOVERY] Found 3 unassigned shards: [2 3 4]
2024/01/01 10:01:05 [RECOVERY] Allocation enabled for index: my_index_3
```
