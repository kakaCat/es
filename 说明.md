## 1. 项目背景

构建一套 Serverless 弹性伸缩的搜索平台，核心需求包括：
- 支持 Elasticsearch 原生搜索能力
- 扩展向量检索（ANN）能力
- 提供 IVF 索引算法（类似 FAISS IVFFLAT 或 HNSW）
- 封装资源调度、扩容、缩容，不暴露底层服务器
- 满足 AI 辅助搜索、RAG、推荐系统 的需求

## 2. 建设总体目标

目标 1：提供可自助使用的 Serverless ES 集群
- 不需要申请机器
- 根据访问量自动伸缩（横向扩容 / 缩容）
- 支持多租户隔离

目标 2：支持向量检索
- 支持高维向量（32 ~ 4096）
- 支持 IVF 索引算法
- 与 ES 文档检索一致对外（统一 Query DSL）
- 支持结构化过滤 + ANN 检索

目标 3：提供 PaaS 化能力
- 平台侧提供 "创建集群"、"索引管理"、"监控" 的 UI
- 提供 SDK / REST API

目标 4：保证可维护性、可观察性
- 管理控制台可查看指标：QPS、延迟、集群状态、索引构建、节点 CPU/内存等
- 日志可接入公司统一日志系统

## 3. 功能需求

### 3.1 用户层功能（对外能力）

#### 3.1.1 集群管理总览
- 创建 / 删除 Serverless ES 集群
- 可配置参数：
  - vCPU：动态/自动
  - 内存上限
  - 最大节点数
  - 索引数量限制
- 一键创建（几分钟完成）

#### 3.1.2 向量索引管理
- 创建向量索引（vector index）
- 支持字段类型：
  - float vector（faiss-like）
  - binary vector（可选）
- 支持参数：
  - dimension（维度）
  - metric：L2 / cosine / dot
  - IVF 参数：nlist、nprobe
  - segment size
- 支持向量数据批量导入（bulk）

#### 3.1.3 搜索 API
支持 DSL 查询，例如：

```json
{
  "size": 10,
  "query": {
    "ann": {
      "field": "embedding",
      "vector": [1.2, 0.5, ...],
      "algorithm": "ivf",
      "nprobe": 8
    },
    "filter": {
      "term": {"category": "news"}
    }
  }
}
```

#### 3.1.4 监控与日志
- 查询 QPS / 延迟（P50 / P95 / P99）
- 向量索引构建进度
- 存储大小 / CPU / 内存 / 负载信息
- 错误日志

### 3.2 后端服务功能（外包需开发）

#### 3.2.1 Serverless 调度系统
- 自动扩缩容：
  - 根据 CPU/QPS/SLA 动态扩容
  - 低负载自动缩容（idle）
- 热点自动分片移动
- 多租户隔离

#### 3.2.2 向量引擎集成（IVF）
- 在 Elasticsearch 插件中实现 IVF 算法：
  - nlist（倒排簇数）
  - nprobe（搜索簇数）
  - cluster centroids 训练（KMeans）
  - 倒排表构建（posting lists）
- 插件需支持：
  - 索引构建
  - 索引更新（增量）
  - 高维向量存储优化（SIMD / AVX512）
  - 查询加速（batching）
  - 与 ES DocID 映射

#### 3.2.3 ES 扩展
- 提供自定义字段类型 `type: vector`
- 提供自定义查询 `ann`
- 提供 REST API
- 插件可被 ES 8.x 以上版本加载

#### 3.2.4 数据持久性
- 全量快照到对象存储（OSS / S3）
- 自动恢复（节点故障后恢复向量索引）
- 无状态计算节点（Serverless 特性）

#### 3.2.5 元数据管理（平台侧）
- 索引元数据管理
- 租户配额管理
- 监控系统适配
- 部署状态管理

### 3.3 平台功能（界面 UI 需求）

#### UI-1：集群列表页面
- 字段：集群名（唯一标识）、状态（运行中/扩容中/构建索引中）、CPU 使用率（实时）、QPS（实时）
- 操作：进入、删除

#### UI-2：索引管理页面
- 创建向量索引
- 查看 IVF 参数
- 重建索引
- 导入数据

#### UI-3：监控页面
- 向量搜索 QPS/延迟
- nprobe 效率曲线
- 节点/Pod 状态
- 向量分布可视化（TSNE 降维，外包可用 Python 实现）

## 4. 架构需求

### 4.1 推荐架构（外包必须实现）

控制平面（Control Plane）
- 负责创建/管理 ES Serverless 集群
- 负责自动扩缩容
- 负责元数据管理

数据平面（Data Plane）
- 多个 ES Node（Serverless），通过 K8s 自动拉起（Pod）
- 注入 IVF 插件
- 使用本地 NVMe + 缓存
- 向量索引存储在 OSS/S3

插件层（ES Plugin）
- 自定义向量字段类型
- IVF 索引构建器
- IVF 搜索器
- SIMD 加速模块
- 内置 KMeans 训练器

## 5. 性能要求（强制）
- 单向量检索延迟 P95 < 20ms（nprobe=16）
- 单集群 QPS > 3,000
- 最大数据规模：1 亿向量（128 维）
- 向量训练（kmeans）< 30 分钟（nlist ≤ 2048）
- 扩容耗时：单节点 < 2 分钟

## 6. 安全 / 权限要求
- 集群级别租户隔离
- Token 认证
- 访问审计日志
- 数据加密（AES-256）
- 数据在 OSS/S3 上按租户隔离

## 7. 交付物要求

### 7.1 源码
- ES IVF Plugin 源码
- 控制平面服务（Serverless Manager）源码
- 数据平面自动化部署脚本（Terraform + Helm）

### 7.2 文档
- API 文档
- 插件开发文档
- 部署文档
- 性能测试报告
- 索引构建的数学原理文档

### 7.3 演示环境
- 可访问的测试 Serverless ES 集群
- Demo：向量插入、IVF 搜索、结构化 + ANN 混合检索

## 8. 验收标准
- 通过全部功能测试
- 通过性能测试（达到指标）
- 无 BUG 崩溃
- 可 0 运维运行 7 天
- 支持高并发压测
- 所有文档齐全
