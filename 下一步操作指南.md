# ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å— - IVF å®ç°å®Œæˆåçš„æ­¥éª¤

## ğŸ¯ å½“å‰çŠ¶æ€

âœ… **IVF ç®—æ³•æ ¸å¿ƒå®ç° - 100% å®Œæˆ**

å·²å®Œæˆçš„æ–‡ä»¶ï¼š
- âœ… VectorSimilarity.java (å‘é‡ç›¸ä¼¼åº¦è®¡ç®—)
- âœ… SimpleKMeansTrainer.java (KMeans èšç±»)
- âœ… InvertedFileIndex.java (å€’æ’ç´¢å¼•)
- âœ… IVFQueryBuilder.java (æŸ¥è¯¢æ„å»ºå™¨ - å·²æ›¿æ¢å ä½ç¬¦)
- âœ… VectorField.java (å‘é‡å­˜å‚¨)
- âœ… VectorFieldMapper.java (æ–‡æ¡£è§£æ - å·²é›†æˆè‡ªåŠ¨ç´¢å¼•)
- âœ… IVFIndexTest.java (å•å…ƒæµ‹è¯•)
- âœ… test-ivf.sh (é›†æˆæµ‹è¯•è„šæœ¬)

æ€»ä»£ç é‡ï¼š~2,645 è¡Œ

---

## âš¡ å¿«é€Ÿå¼€å§‹ï¼ˆ3 æ­¥ï¼‰

### ç¬¬ 1 æ­¥ï¼šå®‰è£… Gradle

```bash
# macOS
brew install gradle

# Ubuntu/Debian
sudo apt-get install gradle

# æˆ–ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
wget https://services.gradle.org/distributions/gradle-8.0-bin.zip
unzip gradle-8.0-bin.zip
export PATH=$PATH:$PWD/gradle-8.0/bin

# éªŒè¯å®‰è£…
gradle --version
```

é¢„æœŸè¾“å‡ºï¼š
```
Gradle 8.0 æˆ–æ›´é«˜ç‰ˆæœ¬
```

---

### ç¬¬ 2 æ­¥ï¼šç¼–è¯‘æ’ä»¶

```bash
cd /Users/yunpeng/Documents/esé¡¹ç›®/es-plugin

# æ¸…ç†å¹¶æ„å»º
gradle clean build

# å¦‚æœæˆåŠŸï¼Œä½ ä¼šçœ‹åˆ°ï¼š
# BUILD SUCCESSFUL in Xs
# ç”Ÿæˆæ–‡ä»¶: build/distributions/es-ivf-plugin-1.0.0.zip
```

---

### ç¬¬ 3 æ­¥ï¼šæ£€æŸ¥æ„å»ºç»“æœ

```bash
# æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
ls -lh build/distributions/

# é¢„æœŸè¾“å‡ºç±»ä¼¼ï¼š
# -rw-r--r--  1 user  staff   1.2M  Nov 30 20:00 es-ivf-plugin-1.0.0.zip

# å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¯´æ˜æ„å»ºæˆåŠŸï¼
```

---

## ğŸ”§ å¦‚æœç¼–è¯‘æˆåŠŸ â†’ ç»§ç»­ä»¥ä¸‹æ­¥éª¤

### 4. è¿è¡Œå•å…ƒæµ‹è¯•

```bash
cd /Users/yunpeng/Documents/esé¡¹ç›®/es-plugin

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
gradle test

# æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
open build/reports/tests/test/index.html
```

é¢„æœŸç»“æœï¼š
```
âœ… testVectorSimilarityL2 - PASSED
âœ… testVectorSimilarityCosine - PASSED
âœ… testKMeansTraining - PASSED
âœ… testIVFIndexSearch - PASSED
âœ… testIVFIndexPersistence - PASSED
... ç­‰ç­‰ ...

Total: 9 tests, 9 passed, 0 failed
```

---

### 5. å®‰è£…æ’ä»¶åˆ° Elasticsearch

#### 5.1 æ£€æŸ¥ Elasticsearch çŠ¶æ€

```bash
# æ£€æŸ¥ ES æ˜¯å¦è¿è¡Œ
curl http://localhost:9200

# é¢„æœŸå“åº”ï¼š
# {
#   "name" : "elasticsearch-0",
#   "cluster_name" : "es-cluster",
#   "version" : { ... }
# }
```

#### 5.2 å®‰è£…æ’ä»¶

**æ–¹æ¡ˆ A: æœ¬åœ° Elasticsearch**
```bash
# å‡è®¾ ES å®‰è£…åœ¨ /usr/local/elasticsearch
ES_HOME=/usr/local/elasticsearch

$ES_HOME/bin/elasticsearch-plugin install \
  file:///Users/yunpeng/Documents/esé¡¹ç›®/es-plugin/build/distributions/es-ivf-plugin-1.0.0.zip

# é‡å¯ ES
sudo systemctl restart elasticsearch
```

**æ–¹æ¡ˆ B: Kubernetes éƒ¨ç½²**
```bash
# 1. å¤åˆ¶æ’ä»¶åˆ° Pod
kubectl cp build/distributions/es-ivf-plugin-1.0.0.zip \
  elasticsearch-0:/tmp/plugin.zip

# 2. åœ¨ Pod ä¸­å®‰è£…
kubectl exec -it elasticsearch-0 -- \
  bin/elasticsearch-plugin install file:///tmp/plugin.zip

# 3. é‡å¯ StatefulSet
kubectl rollout restart statefulset elasticsearch

# 4. ç­‰å¾… Pod å°±ç»ª
kubectl get pods -w
```

**æ–¹æ¡ˆ C: Docker Compose**
```bash
# 1. å¤åˆ¶åˆ°å®¹å™¨
docker cp build/distributions/es-ivf-plugin-1.0.0.zip \
  elasticsearch:/tmp/plugin.zip

# 2. å®‰è£…
docker exec -it elasticsearch \
  bin/elasticsearch-plugin install file:///tmp/plugin.zip

# 3. é‡å¯å®¹å™¨
docker restart elasticsearch
```

#### 5.3 éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥å·²å®‰è£…çš„æ’ä»¶
curl http://localhost:9200/_cat/plugins

# é¢„æœŸè¾“å‡ºåŒ…å«ï¼š
# elasticsearch-0  es-ivf-plugin  1.0.0
```

---

### 6. è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•

```bash
cd /Users/yunpeng/Documents/esé¡¹ç›®

# ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
chmod +x scripts/test-ivf.sh

# è¿è¡Œæµ‹è¯•
./scripts/test-ivf.sh

# å¦‚æœéœ€è¦æŒ‡å®š ES URL
ES_URL=http://localhost:9200 ./scripts/test-ivf.sh
```

é¢„æœŸè¾“å‡ºï¼š
```
=========================================
IVF Vector Search Test Script
=========================================
Elasticsearch URL: http://localhost:9200
Index: test_vectors
Vector Dimension: 128

[1/5] Cleaning up existing index...
[2/5] Creating index with vector field...
{"acknowledged":true}

[3/5] Indexing test vectors...
  Indexed 20 documents...
  Indexed 40 documents...
  ...
  Indexed 100 documents total

[4/5] Refreshing index...
{"_shards":{"total":1,"successful":1,"failed":0}}

[5/5] Performing vector search...

=== IVF ANN Search ===
{
  "id": "42",
  "score": 0.95,
  "title": "Document 42"
}
...

=========================================
Test completed!
=========================================
```

---

### 7. æ‰‹åŠ¨æµ‹è¯•

#### 7.1 åˆ›å»ºå‘é‡ç´¢å¼•

```bash
curl -X PUT "localhost:9200/my_vectors" -H 'Content-Type: application/json' -d'
{
  "mappings": {
    "properties": {
      "title": { "type": "text" },
      "embedding": {
        "type": "vector",
        "dimension": 128,
        "metric": "l2",
        "nlist": 100,
        "nprobe": 10
      }
    }
  }
}
'
```

#### 7.2 æ’å…¥æµ‹è¯•å‘é‡

```bash
# ç”Ÿæˆä¸€ä¸ª 128 ç»´éšæœºå‘é‡çš„ Python è„šæœ¬
python3 << 'EOF'
import json
import random

vector = [random.uniform(-1, 1) for _ in range(128)]
doc = {
    "title": "Test Document",
    "embedding": vector
}
print(json.dumps(doc))
EOF
```

å°†è¾“å‡ºä¿å­˜ä¸º `doc.json`ï¼Œç„¶åï¼š

```bash
curl -X POST "localhost:9200/my_vectors/_doc/1" \
  -H 'Content-Type: application/json' \
  -d @doc.json
```

#### 7.3 æ‰§è¡Œæœç´¢

```bash
# ä½¿ç”¨ç›¸åŒçš„å‘é‡æœç´¢ï¼ˆåº”è¯¥è¿”å›è‡ªå·±ï¼‰
curl -X POST "localhost:9200/my_vectors/_search" \
  -H 'Content-Type: application/json' \
  -d '{
  "query": {
    "ann": {
      "field": "embedding",
      "vector": [/* ç²˜è´´ä¸Šé¢ç”Ÿæˆçš„å‘é‡ */],
      "nprobe": 10,
      "k": 5
    }
  }
}'
```

---

## ğŸš¨ å¦‚æœç¼–è¯‘å¤±è´¥ â†’ é—®é¢˜æ’æŸ¥

### å¸¸è§é”™è¯¯ 1: æ‰¾ä¸åˆ° Gradle

**é”™è¯¯ä¿¡æ¯:**
```
gradle: command not found
```

**è§£å†³æ–¹æ¡ˆ:**
```bash
# å®‰è£… Gradle
brew install gradle  # macOS
# æˆ–
sudo apt-get install gradle  # Ubuntu
```

---

### å¸¸è§é”™è¯¯ 2: Java ç‰ˆæœ¬ä¸å…¼å®¹

**é”™è¯¯ä¿¡æ¯:**
```
Unsupported class file major version XX
```

**è§£å†³æ–¹æ¡ˆ:**
```bash
# æ£€æŸ¥ Java ç‰ˆæœ¬
java -version

# éœ€è¦ Java 11 æˆ–æ›´é«˜ç‰ˆæœ¬
# macOS å®‰è£… Java 11:
brew install openjdk@11

# Ubuntu:
sudo apt-get install openjdk-11-jdk

# è®¾ç½®ç¯å¢ƒå˜é‡
export JAVA_HOME=/path/to/java-11
```

---

### å¸¸è§é”™è¯¯ 3: Elasticsearch ç‰ˆæœ¬ä¸å…¼å®¹

**é”™è¯¯ä¿¡æ¯:**
```
Cannot resolve symbol 'XContentParser'
Cannot resolve symbol 'SearchExecutionContext'
```

**åŸå› :** Elasticsearch 8.x ä¿®æ”¹äº†åŒ…è·¯å¾„

**è§£å†³æ–¹æ¡ˆ:** æ£€æŸ¥ `build.gradle` ä¸­çš„ ES ç‰ˆæœ¬

```gradle
// æ£€æŸ¥è¿™è¡Œ
elasticsearch {
    version = '8.15.3'  // ç¡®ä¿ä¸ä½ çš„ ES ç‰ˆæœ¬åŒ¹é…
}
```

å¦‚æœç‰ˆæœ¬ä¸åŒ¹é…ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å¯¼å…¥è¯­å¥ã€‚

---

### å¸¸è§é”™è¯¯ 4: ç¼–è¯‘é€šè¿‡ä½†æµ‹è¯•å¤±è´¥

**å¯èƒ½åŸå› :**
- ç¼ºå°‘ä¾èµ–
- æµ‹è¯•ç¯å¢ƒé…ç½®é—®é¢˜

**æ’æŸ¥æ­¥éª¤:**
```bash
# æŸ¥çœ‹è¯¦ç»†æµ‹è¯•è¾“å‡º
gradle test --info

# æŸ¥çœ‹å¤±è´¥çš„å…·ä½“æµ‹è¯•
cat build/reports/tests/test/index.html
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨ç»§ç»­ä¹‹å‰ï¼Œç¡®ä¿ï¼š

- [ ] Gradle å·²å®‰è£…ï¼ˆ`gradle --version`ï¼‰
- [ ] Java 11+ å·²å®‰è£…ï¼ˆ`java -version`ï¼‰
- [ ] Elasticsearch æ­£åœ¨è¿è¡Œï¼ˆ`curl localhost:9200`ï¼‰
- [ ] èƒ½è®¿é—®æ’ä»¶æºç ç›®å½•

å®Œæˆç¼–è¯‘åï¼š

- [ ] æ’ä»¶ ZIP æ–‡ä»¶å·²ç”Ÿæˆï¼ˆ`ls build/distributions/`ï¼‰
- [ ] å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆ`gradle test`ï¼‰
- [ ] æ’ä»¶å·²å®‰è£…åˆ° ESï¼ˆ`curl localhost:9200/_cat/plugins`ï¼‰
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆ`./scripts/test-ivf.sh`ï¼‰

---

## ğŸ¯ é¢„æœŸæ—¶é—´è¡¨

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | è¯´æ˜ |
|------|----------|------|
| å®‰è£… Gradle | 5-10 åˆ†é’Ÿ | å¦‚æœä½¿ç”¨åŒ…ç®¡ç†å™¨ |
| é¦–æ¬¡ç¼–è¯‘ | 5-15 åˆ†é’Ÿ | ä¸‹è½½ä¾èµ–éœ€è¦æ—¶é—´ |
| è¿è¡Œæµ‹è¯• | 5-10 åˆ†é’Ÿ | 9 ä¸ªå•å…ƒæµ‹è¯• |
| å®‰è£…æ’ä»¶ | 5 åˆ†é’Ÿ | å¤åˆ¶ + é‡å¯ ES |
| é›†æˆæµ‹è¯• | 5-10 åˆ†é’Ÿ | 100 ä¸ªå‘é‡æµ‹è¯• |
| **æ€»è®¡** | **25-50 åˆ†é’Ÿ** | å¦‚æœä¸€åˆ‡é¡ºåˆ© |

---

## ğŸ’¡ ä¸“ä¸šæç¤º

### æç¤º 1: ä¿ç•™æ„å»ºç¼“å­˜

ç¼–è¯‘æˆåŠŸåï¼Œä¸è¦åˆ é™¤ `build/` ç›®å½•ï¼Œè¿™æ ·åç»­é‡æ–°ç¼–è¯‘ä¼šæ›´å¿«ï¼š

```bash
# åªæ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶ï¼Œä¿ç•™ä¾èµ–ç¼“å­˜
gradle clean

# è€Œä¸æ˜¯
rm -rf build/
```

### æç¤º 2: ä½¿ç”¨ Gradle Daemon

Gradle Daemon å¯ä»¥åŠ é€Ÿåç»­æ„å»ºï¼š

```bash
# å¯ç”¨ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰
gradle --daemon build

# æŸ¥çœ‹çŠ¶æ€
gradle --status
```

### æç¤º 3: å¹¶è¡Œæµ‹è¯•

å¦‚æœæµ‹è¯•è¾ƒæ…¢ï¼Œå¯ä»¥å¯ç”¨å¹¶è¡Œï¼š

```gradle
// åœ¨ build.gradle ä¸­æ·»åŠ 
test {
    maxParallelForks = Runtime.runtime.availableProcessors()
}
```

### æç¤º 4: å¼€å‘æ—¶çƒ­é‡è½½

å¼€å‘æ—¶å¯ä»¥ä½¿ç”¨ï¼š

```bash
# ç›‘å¬æ–‡ä»¶å˜åŒ–è‡ªåŠ¨é‡æ–°ç¼–è¯‘
gradle build --continuous
```

---

## ğŸ“ é‡åˆ°é—®é¢˜ï¼Ÿ

### å¦‚æœç¼–è¯‘å¤±è´¥

1. å¤åˆ¶å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥ `build.gradle` é…ç½®
3. éªŒè¯ ES ç‰ˆæœ¬å’Œå¯¼å…¥è·¯å¾„
4. æŸ¥çœ‹ Gradle æ—¥å¿—ï¼š`gradle build --stacktrace`

### å¦‚æœæµ‹è¯•å¤±è´¥

1. æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Šï¼š`build/reports/tests/test/index.html`
2. è¿è¡Œå•ä¸ªæµ‹è¯•ï¼š`gradle test --tests "IVFIndexTest.testKMeansTraining"`
3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š`gradle test --debug`

### å¦‚æœè¿è¡Œæ—¶é”™è¯¯

1. æ£€æŸ¥ ES æ—¥å¿—ï¼š`tail -f /var/log/elasticsearch/es-cluster.log`
2. æˆ– Kubernetesï¼š`kubectl logs elasticsearch-0`
3. æŸ¥æ‰¾å…³é”®è¯ï¼š"IVF"ã€"vector"ã€"plugin"

---

## ğŸ‰ æˆåŠŸæ ‡å‡†

å½“ä½ çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºæ—¶ï¼Œè¯´æ˜ä¸€åˆ‡æ­£å¸¸ï¼š

```bash
# 1. ç¼–è¯‘æˆåŠŸ
BUILD SUCCESSFUL in 10s

# 2. æµ‹è¯•é€šè¿‡
9 tests completed, 9 passed

# 3. æ’ä»¶å·²å®‰è£…
elasticsearch-0  es-ivf-plugin  1.0.0

# 4. æœç´¢æ­£å¸¸å·¥ä½œ
{
  "hits": {
    "total": { "value": 5 },
    "hits": [
      { "_id": "1", "_score": 0.95 },
      ...
    ]
  }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [IVFå®ç°å®Œæˆè¯´æ˜.md](IVFå®ç°å®Œæˆè¯´æ˜.md) - æŠ€æœ¯ç»†èŠ‚
- [IVFä½¿ç”¨æŒ‡å—.md](es-plugin/IVFä½¿ç”¨æŒ‡å—.md) - ç”¨æˆ·æ‰‹å†Œ
- [IVFå®ç°æ€»ç»“.md](IVFå®ç°æ€»ç»“.md) - é¡¹ç›®æ€»ç»“
- [æ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆçº§æ¸…å•.md](æ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆçº§æ¸…å•.md) - ä»»åŠ¡æ¸…å•

---

## âœ… è¡ŒåŠ¨é¡¹

**ç°åœ¨å°±åšï¼š**

```bash
# 1. å®‰è£… Gradle
brew install gradle

# 2. åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd /Users/yunpeng/Documents/esé¡¹ç›®/es-plugin

# 3. å°è¯•ç¼–è¯‘
gradle clean build

# 4. æŠ¥å‘Šç»“æœï¼ˆæˆåŠŸæˆ–é”™è¯¯ä¿¡æ¯ï¼‰
```

**ç¼–è¯‘æˆåŠŸåç«‹å³æ‰§è¡Œï¼š**

```bash
# 5. è¿è¡Œæµ‹è¯•
gradle test

# 6. æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
ls -lh build/distributions/

# 7. å®‰è£…åˆ° ES
# (æ ¹æ®ä½ çš„éƒ¨ç½²æ–¹å¼é€‰æ‹©ä¸Šé¢çš„æ–¹æ¡ˆ)

# 8. è¿è¡Œé›†æˆæµ‹è¯•
./scripts/test-ivf.sh
```

---

**æœ€åæ›´æ–°:** 2025-11-30
**ä¸‹ä¸€æ­¥:** æ‰§è¡Œ `gradle clean build`
**çŠ¶æ€:** ç­‰å¾…ç¼–è¯‘ç»“æœ

---

Good luck! ğŸš€
