# ES Serverless é¡¹ç›®è¡¥å……ç»†èŠ‚æ¸…å•

æœ¬æ–‡æ¡£è¡¥å……ã€Šå®ç°æƒ…å†µæ¸…å•.mdã€‹ä¸­æœªè¦†ç›–ä½†ã€Šè¯´æ˜.mdã€‹æ˜ç¡®è¦æ±‚çš„åŠŸèƒ½ç»†èŠ‚ã€‚

---

## ğŸ”´ å…³é”®é—æ¼é¡¹ï¼ˆå¿…é¡»å®ç°ï¼‰

### 1. UI åŠŸèƒ½å®Œå–„ âš ï¸ **éƒ¨åˆ†å®ç°**

**å½“å‰çŠ¶æ€:** åŸºç¡€ Web UI å·²å®ç° ([frontend/index.html](frontend/index.html))ï¼Œä½†åŠŸèƒ½æœ‰é™

**å·²å®ç°åŠŸèƒ½:**
- âœ… é›†ç¾¤åˆ›å»ºè¡¨å•ï¼ˆæ”¯æŒå¤šç§Ÿæˆ·å‚æ•°ï¼‰
- âœ… é›†ç¾¤åˆ é™¤åŠŸèƒ½
- âœ… é›†ç¾¤åˆ—è¡¨æŸ¥è¯¢
- âœ… é›†ç¾¤è¯¦æƒ…æŸ¥è¯¢

**éœ€è¦è¡¥å……çš„åŠŸèƒ½:**

#### UI-2: ç´¢å¼•ç®¡ç†é¡µé¢ï¼ˆã€Šè¯´æ˜.mdã€‹3.3 è¦æ±‚ï¼‰

```markdown
- [ ] åˆ›å»ºå‘é‡ç´¢å¼•ç•Œé¢
  - [ ] ç´¢å¼•åç§°è¾“å…¥
  - [ ] IVF å‚æ•°é…ç½®ï¼ˆnlist, nprobeï¼‰
  - [ ] å‘é‡ç»´åº¦è®¾ç½®
  - [ ] è·ç¦»åº¦é‡é€‰æ‹©ï¼ˆL2/Cosine/Dotï¼‰

- [ ] æŸ¥çœ‹ IVF å‚æ•°
  - [ ] æ˜¾ç¤ºå½“å‰ç´¢å¼•çš„ nlist/nprobe é…ç½®
  - [ ] æ˜¾ç¤ºèšç±»ä¸­å¿ƒæ•°é‡

- [ ] é‡å»ºç´¢å¼•åŠŸèƒ½
  - [ ] è§¦å‘é‡æ–°è®­ç»ƒ KMeans
  - [ ] æ˜¾ç¤ºé‡å»ºè¿›åº¦

- [ ] å¯¼å…¥æ•°æ®åŠŸèƒ½
  - [ ] æ‰¹é‡å‘é‡ä¸Šä¼ ç•Œé¢
  - [ ] CSV/JSON æ–‡ä»¶å¯¼å…¥
  - [ ] å¯¼å…¥è¿›åº¦æ˜¾ç¤º
```

#### UI-3: ç›‘æ§é¡µé¢ï¼ˆã€Šè¯´æ˜.mdã€‹3.3 è¦æ±‚ï¼‰

```markdown
- [ ] å‘é‡æœç´¢ QPS/å»¶è¿Ÿå›¾è¡¨
  - [ ] å®æ—¶ QPS æ›²çº¿å›¾
  - [ ] P50/P95/P99 å»¶è¿Ÿåˆ†å¸ƒå›¾
  - [ ] æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ï¼ˆ1h/6h/24h/7dï¼‰

- [ ] nprobe æ•ˆç‡æ›²çº¿
  - [ ] ä¸åŒ nprobe å€¼çš„å¬å›ç‡å¯¹æ¯”
  - [ ] å»¶è¿Ÿ vs nprobe å…³ç³»å›¾

- [ ] èŠ‚ç‚¹/Pod çŠ¶æ€
  - [ ] é›†ç¾¤æ‹“æ‰‘å›¾ï¼ˆèŠ‚ç‚¹åˆ†å¸ƒï¼‰
  - [ ] æ¯ä¸ªèŠ‚ç‚¹çš„å¥åº·çŠ¶æ€
  - [ ] CPU/å†…å­˜ä½¿ç”¨ç‡å®æ—¶æ˜¾ç¤º

- [ ] â­ å‘é‡åˆ†å¸ƒå¯è§†åŒ–ï¼ˆè¯´æ˜.md ç‰¹åˆ«è¦æ±‚ï¼šTSNE é™ç»´ï¼‰
  - [ ] Python åç«¯æœåŠ¡å®ç° TSNE é™ç»´
  - [ ] å‰ç«¯ Canvas/D3.js æ¸²æŸ“æ•£ç‚¹å›¾
  - [ ] äº¤äº’å¼ç¼©æ”¾å’Œæ¢ç´¢
```

#### é€šç”¨ UI æ”¹è¿›

```markdown
- [ ] æ·»åŠ ç”¨æˆ·ç™»å½•ç•Œé¢ï¼ˆé…åˆè®¤è¯åŠŸèƒ½ï¼‰
- [ ] æ·»åŠ é”™è¯¯æç¤ºå’ŒæˆåŠŸæ¶ˆæ¯
- [ ] å“åº”å¼è®¾è®¡ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰
- [ ] æ·±è‰²æ¨¡å¼æ”¯æŒ
- [ ] å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­è‹±æ–‡åˆ‡æ¢ï¼‰
```

**æ–‡ä»¶ä½ç½®:**
- `frontend/index-management.html` (æ–°å»º)
- `frontend/monitoring.html` (æ–°å»º)
- `frontend/js/charts.js` (æ–°å»º - å›¾è¡¨ç»„ä»¶)
- `frontend/js/auth.js` (æ–°å»º - è®¤è¯é€»è¾‘)

**éªŒæ”¶æ ‡å‡†:**
- [ ] ç´¢å¼•ç®¡ç†é¡µé¢å¯ä»¥åˆ›å»ºå’Œç®¡ç†å‘é‡ç´¢å¼•
- [ ] ç›‘æ§é¡µé¢æ˜¾ç¤ºå®æ—¶æ€§èƒ½æŒ‡æ ‡
- [ ] TSNE å¯è§†åŒ–èƒ½å¤Ÿå±•ç¤ºå‘é‡åˆ†å¸ƒ
- [ ] UI å“åº”é€Ÿåº¦ < 1 ç§’

---

### 2. å‘é‡åˆ†å¸ƒå¯è§†åŒ–ï¼ˆTSNE é™ç»´ï¼‰â­ **æœªå®ç° - è¯´æ˜.md ç‰¹åˆ«è¦æ±‚**

**éœ€æ±‚æ¥æº:** ã€Šè¯´æ˜.mdã€‹3.3 UI-3 æ˜ç¡®è¦æ±‚ï¼š"å‘é‡åˆ†å¸ƒå¯è§†åŒ–ï¼ˆTSNE é™ç»´ï¼Œå¤–åŒ…å¯ç”¨ Python å®ç°ï¼‰"

**éœ€è¦å®ç°çš„å†…å®¹:**

#### Python å¾®æœåŠ¡

```python
# åˆ›å»º services/vector-visualization/

- [ ] app.py - Flask/FastAPI åç«¯
  ```python
  from sklearn.manifold import TSNE
  import numpy as np
  from flask import Flask, request, jsonify

  @app.route('/visualize', methods=['POST'])
  def visualize_vectors():
      """
      æ¥æ”¶å‘é‡åˆ—è¡¨ï¼Œæ‰§è¡Œ TSNE é™ç»´ï¼Œè¿”å› 2D åæ ‡

      Request:
      {
        "vectors": [[1.2, 0.5, ...], [...], ...],
        "perplexity": 30,
        "n_iter": 1000
      }

      Response:
      {
        "coordinates": [[x1, y1], [x2, y2], ...],
        "execution_time_ms": 1234
      }
      """
      pass

  @app.route('/cluster', methods=['POST'])
  def cluster_vectors():
      """
      å¯¹å‘é‡è¿›è¡Œèšç±»åˆ†æ
      """
      pass
  ```

- [ ] requirements.txt
  ```
  scikit-learn>=1.0.0
  numpy>=1.21.0
  flask>=2.0.0
  gunicorn>=20.1.0
  ```

- [ ] Dockerfile
  ```dockerfile
  FROM python:3.9-slim
  WORKDIR /app
  COPY requirements.txt .
  RUN pip install -r requirements.txt
  COPY . .
  CMD ["gunicorn", "-b", "0.0.0.0:5000", "app:app"]
  ```

- [ ] k8s éƒ¨ç½²é…ç½®
  - k8s/addons/visualization/deployment.yaml
  - k8s/addons/visualization/service.yaml
```

#### å‰ç«¯é›†æˆ

```javascript
// frontend/js/tsne-visualizer.js

- [ ] å‘é‡å¯è§†åŒ–ç»„ä»¶
  ```javascript
  class TSNEVisualizer {
    constructor(canvasId) {
      this.canvas = document.getElementById(canvasId);
      this.ctx = this.canvas.getContext('2d');
    }

    async fetchAndVisualize(namespace, indexName) {
      // 1. ä» ES è·å–å‘é‡æ•°æ®
      const vectors = await this.fetchVectors(namespace, indexName);

      // 2. è°ƒç”¨ Python æœåŠ¡è¿›è¡Œ TSNE é™ç»´
      const coordinates = await this.performTSNE(vectors);

      // 3. æ¸²æŸ“æ•£ç‚¹å›¾
      this.renderScatterPlot(coordinates);
    }

    renderScatterPlot(coordinates) {
      // ä½¿ç”¨ Canvas æˆ– D3.js ç»˜åˆ¶
    }
  }
  ```

- [ ] D3.js æˆ– Chart.js é›†æˆ
- [ ] äº¤äº’åŠŸèƒ½
  - ç¼©æ”¾å’Œå¹³ç§»
  - ç‚¹å‡»å‘é‡æŸ¥çœ‹è¯¦æƒ…
  - èšç±»é«˜äº®æ˜¾ç¤º
```

**éªŒæ”¶æ ‡å‡†:**
- [ ] å¯ä»¥å¯è§†åŒ–è‡³å°‘ 10,000 ä¸ªå‘é‡
- [ ] TSNE é™ç»´è€—æ—¶ < 30 ç§’
- [ ] å‰ç«¯æ¸²æŸ“æµç•…ï¼ˆ60fpsï¼‰
- [ ] æ”¯æŒå‘é‡èšç±»é«˜äº®æ˜¾ç¤º

---

### 3. å‘é‡æ•°æ®æ‰¹é‡å¯¼å…¥å·¥å…· âŒ **æœªå®ç°**

**éœ€æ±‚æ¥æº:** ã€Šè¯´æ˜.mdã€‹3.1.2 è¦æ±‚æ”¯æŒå‘é‡æ•°æ®æ‰¹é‡å¯¼å…¥ï¼ˆbulkï¼‰

**éœ€è¦å®ç°çš„å†…å®¹:**

```bash
# åˆ›å»º tools/vector-importer/

- [ ] bulk-import.py - Python æ‰¹é‡å¯¼å…¥è„šæœ¬
  ```python
  """
  å‘é‡æ‰¹é‡å¯¼å…¥å·¥å…·

  ç”¨æ³•:
  python bulk-import.py \
    --es-host http://localhost:9200 \
    --index my-vectors \
    --file vectors.csv \
    --batch-size 1000 \
    --workers 4
  """

  æ”¯æŒæ ¼å¼:
  - CSV: id,vector,metadata
  - JSON Lines: {"vector": [1.2, 0.5], "metadata": {...}}
  - NumPy: .npy æ–‡ä»¶
  ```

- [ ] validate-vectors.py - å‘é‡æ•°æ®éªŒè¯
  ```python
  åŠŸèƒ½:
  - æ£€æŸ¥å‘é‡ç»´åº¦ä¸€è‡´æ€§
  - æ£€æŸ¥æ•°å€¼èŒƒå›´åˆæ³•æ€§
  - æ£€æŸ¥æ˜¯å¦æœ‰ NaN/Inf å€¼
  - ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Š
  ```

- [ ] generate-sample-data.py - ç”Ÿæˆæµ‹è¯•æ•°æ®
  ```python
  åŠŸèƒ½:
  - ç”Ÿæˆéšæœºå‘é‡æ•°æ®é›†
  - æ”¯æŒä¸åŒåˆ†å¸ƒï¼ˆæ­£æ€åˆ†å¸ƒã€å‡åŒ€åˆ†å¸ƒï¼‰
  - ç”Ÿæˆä¸åŒè§„æ¨¡æ•°æ®é›†ï¼ˆ1k/10k/100k/1M/10Mï¼‰
  - ç”Ÿæˆå¸¦æ ‡ç­¾çš„æ•°æ®ï¼ˆç”¨äºæµ‹è¯•å¬å›ç‡ï¼‰
  ```

- [ ] å¯¼å…¥å·¥å…·æ–‡æ¡£
  - README.md ä½¿ç”¨è¯´æ˜
  - examples/ ç¤ºä¾‹æ•°æ®é›†
  - æ€§èƒ½åŸºå‡†ï¼ˆå¯¼å…¥é€Ÿåº¦ï¼‰
```

**éªŒæ”¶æ ‡å‡†:**
- [ ] å¯ä»¥ä» CSV æ–‡ä»¶æ‰¹é‡å¯¼å…¥å‘é‡
- [ ] å¯¼å…¥é€Ÿåº¦ > 1,000 vectors/second
- [ ] æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- [ ] é”™è¯¯å¤„ç†å®Œå–„ï¼ˆéƒ¨åˆ†å¤±è´¥ä¸å½±å“å…¶ä»–æ•°æ®ï¼‰

---

### 4. Elasticsearch X-Pack Security ç¦ç”¨é£é™© ğŸš¨ **ä¸¥é‡å®‰å…¨é—®é¢˜**

**é—®é¢˜æè¿°:**
- ä½ç½®: [k8s/base/elasticsearch-statefulset.yaml:32](k8s/base/elasticsearch-statefulset.yaml#L32)
- å½“å‰é…ç½®: `xpack.security.enabled: "false"`
- é£é™©: **ç”Ÿäº§ç¯å¢ƒä¸å¯æ¥å—ï¼Œæ•°æ®å®Œå…¨æš´éœ²ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®**

**éœ€è¦ä¿®å¤çš„å†…å®¹:**

```yaml
- [ ] å¯ç”¨ Elasticsearch å®‰å…¨åŠŸèƒ½

  # 1. ä¿®æ”¹ k8s/base/elasticsearch-configmap.yaml
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: elasticsearch-config
  data:
    elasticsearch.yml: |
      xpack.security.enabled: true                    # å¯ç”¨å®‰å…¨
      xpack.security.transport.ssl.enabled: true      # èŠ‚ç‚¹é—´é€šä¿¡åŠ å¯†
      xpack.security.http.ssl.enabled: true           # HTTP API åŠ å¯†
      xpack.security.transport.ssl.verification_mode: certificate
      xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12
      xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12

- [ ] ç”Ÿæˆ SSL è¯ä¹¦
  ```bash
  # ä½¿ç”¨ elasticsearch-certutil ç”Ÿæˆè¯ä¹¦
  bin/elasticsearch-certutil ca --out elastic-stack-ca.p12
  bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 \
    --out elastic-certificates.p12

  # å°†è¯ä¹¦å­˜å‚¨åˆ° Kubernetes Secret
  kubectl create secret generic elastic-certificates \
    --from-file=elastic-certificates.p12 \
    -n es-serverless
  ```

- [ ] é…ç½®ç”¨æˆ·è®¤è¯
  ```bash
  # åˆ›å»ºå†…ç½®ç”¨æˆ·å¯†ç 
  bin/elasticsearch-setup-passwords auto

  # å°†å¯†ç å­˜å‚¨åˆ° Kubernetes Secret
  kubectl create secret generic elastic-credentials \
    --from-literal=elastic-password=<PASSWORD> \
    --from-literal=kibana-password=<PASSWORD> \
    -n es-serverless
  ```

- [ ] é…ç½®è§’è‰²å’Œæƒé™
  ```json
  // ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹è§’è‰²
  PUT /_security/role/tenant_org_001_role
  {
    "indices": [
      {
        "names": ["org-001-*"],
        "privileges": ["read", "write", "create_index"]
      }
    ]
  }
  ```

- [ ] æ›´æ–°æ‰€æœ‰è®¿é—® ES çš„ä»£ç 
  - [ ] server/es_client.go æ·»åŠ è®¤è¯
    ```go
    config := elasticsearch.Config{
      Addresses: []string{"https://elasticsearch:9200"},
      Username:  "elastic",
      Password:  os.Getenv("ES_PASSWORD"),
      Transport: &http.Transport{
        TLSClientConfig: &tls.Config{
          InsecureSkipVerify: false,
        },
      },
    }
    ```

  - [ ] å‰ç«¯ API è°ƒç”¨æ·»åŠ è®¤è¯å¤´
  - [ ] ç›‘æ§ç»„ä»¶ï¼ˆPrometheus Exporterï¼‰æ·»åŠ è®¤è¯
```

**éªŒæ”¶æ ‡å‡†:**
- [ ] æœªè®¤è¯è¯·æ±‚è¿”å› 401 Unauthorized
- [ ] ä¸åŒç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»
- [ ] TLS åŠ å¯†å¯ç”¨ï¼ˆHTTPSï¼‰
- [ ] æ‰€æœ‰æœåŠ¡æ­£å¸¸å·¥ä½œ
- [ ] é€šè¿‡å®‰å…¨æ‰«ææµ‹è¯•

---

### 5. é…é¢ç®¡ç†å¼ºåˆ¶æ‰§è¡Œ âš ï¸ **éƒ¨åˆ†å®ç°**

**å½“å‰çŠ¶æ€:** TenantQuota æ•°æ®ç»“æ„å­˜åœ¨ï¼Œä½†ç¼ºå°‘å¼ºåˆ¶æ‰§è¡Œé€»è¾‘

**éœ€è¦å®ç°çš„å†…å®¹:**

```go
// server/quota_enforcer.go (æ–°å»º)

- [ ] é…é¢æ£€æŸ¥é€»è¾‘
  ```go
  type QuotaEnforcer struct {
    metadataService *MetadataService
  }

  func (qe *QuotaEnforcer) CheckQuota(tenantOrgID string, resourceType string, requestedAmount int) error {
    // 1. è·å–ç§Ÿæˆ·é…é¢
    quota, err := qe.metadataService.GetTenantQuota(tenantOrgID)

    // 2. è·å–å½“å‰ä½¿ç”¨é‡
    usage, err := qe.getCurrentUsage(tenantOrgID, resourceType)

    // 3. æ£€æŸ¥æ˜¯å¦è¶…é™
    if usage + requestedAmount > quota.Limit {
      return fmt.Errorf("quota exceeded: %s usage %d + %d > limit %d",
        resourceType, usage, requestedAmount, quota.Limit)
    }

    return nil
  }
  ```

- [ ] å¤šç»´åº¦é…é¢é™åˆ¶
  - [ ] CPU æ€»é‡é™åˆ¶ï¼ˆcoresï¼‰
  - [ ] å†…å­˜æ€»é‡é™åˆ¶ï¼ˆGBï¼‰
  - [ ] å­˜å‚¨æ€»é‡é™åˆ¶ï¼ˆGBï¼‰
  - [ ] é›†ç¾¤æ•°é‡é™åˆ¶
  - [ ] ç´¢å¼•æ•°é‡é™åˆ¶
  - [ ] QPS é™åˆ¶ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰

- [ ] é…é¢å‘Šè­¦
  ```go
  func (qe *QuotaEnforcer) MonitorQuotaUsage() {
    // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    ticker := time.NewTicker(1 * time.Hour)
    for range ticker.C {
      for _, tenant := range getAllTenants() {
        usage := getUsagePercentage(tenant.ID)
        if usage > 80 {
          sendQuotaAlert(tenant, usage)
        }
      }
    }
  }
  ```

- [ ] é…é¢ç®¡ç† API
  ```go
  // GET /tenant/quotas/{tenant_org_id}
  // PUT /tenant/quotas/{tenant_org_id}
  // POST /tenant/quotas/{tenant_org_id}/request-increase
  ```

- [ ] å‰ç«¯é…é¢ä»ªè¡¨ç›˜
  - æ˜¾ç¤ºå„ç»´åº¦é…é¢ä½¿ç”¨ç‡
  - é…é¢å†å²è¶‹åŠ¿å›¾
  - é…é¢å¢åŠ è¯·æ±‚è¡¨å•
```

**éªŒæ”¶æ ‡å‡†:**
- [ ] è¶…é…é¢è¯·æ±‚è¢«æ‹’ç»å¹¶è¿”å›æ˜ç¡®é”™è¯¯
- [ ] é…é¢å‘Šè­¦æ­£å¸¸è§¦å‘ï¼ˆä½¿ç”¨ç‡ > 80%ï¼‰
- [ ] ç§Ÿæˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„é…é¢ä½¿ç”¨æƒ…å†µ
- [ ] ç®¡ç†å‘˜å¯ä»¥è°ƒæ•´ç§Ÿæˆ·é…é¢

---

### 6. æ•°æ®å¤‡ä»½å’Œæ¢å¤è‡ªåŠ¨åŒ– âš ï¸ **éƒ¨åˆ†å®ç°**

**å½“å‰çŠ¶æ€:** MinIO å·²éƒ¨ç½²ï¼Œä½†ç¼ºå°‘è‡ªåŠ¨åŒ–å¤‡ä»½æµç¨‹

**éœ€è¦å®ç°çš„å†…å®¹:**

```bash
# scripts/backup/

- [ ] backup-es-snapshot.sh
  ```bash
  #!/bin/bash
  # åˆ›å»º Elasticsearch å¿«ç…§

  # 1. æ³¨å†Œå¿«ç…§ä»“åº“
  curl -X PUT "localhost:9200/_snapshot/my_backup" \
    -H 'Content-Type: application/json' \
    -d '{
      "type": "s3",
      "settings": {
        "bucket": "es-backups",
        "endpoint": "minio:9000",
        "protocol": "http"
      }
    }'

  # 2. åˆ›å»ºå¿«ç…§
  SNAPSHOT_NAME="snapshot_$(date +%Y%m%d_%H%M%S)"
  curl -X PUT "localhost:9200/_snapshot/my_backup/$SNAPSHOT_NAME?wait_for_completion=true"

  # 3. æ¸…ç†æ—§å¿«ç…§ï¼ˆä¿ç•™æœ€è¿‘ 7 å¤©ï¼‰
  ```

- [ ] restore-from-snapshot.sh
  ```bash
  #!/bin/bash
  # ä»å¿«ç…§æ¢å¤æ•°æ®

  SNAPSHOT_NAME=$1

  # 1. åˆ—å‡ºå¯ç”¨å¿«ç…§
  curl "localhost:9200/_snapshot/my_backup/_all"

  # 2. æ¢å¤æŒ‡å®šå¿«ç…§
  curl -X POST "localhost:9200/_snapshot/my_backup/$SNAPSHOT_NAME/_restore"

  # 3. éªŒè¯æ¢å¤å®Œæ•´æ€§
  ```

- [ ] backup-metadata.sh
  ```bash
  #!/bin/bash
  # å¤‡ä»½ PostgreSQL å…ƒæ•°æ®

  pg_dump -h localhost -U es_user es_metadata > metadata_backup.sql

  # åŠ å¯†å¤‡ä»½æ–‡ä»¶
  openssl enc -aes-256-cbc -salt \
    -in metadata_backup.sql \
    -out metadata_backup.sql.enc \
    -k $BACKUP_PASSWORD

  # ä¸Šä¼ åˆ° S3/MinIO
  mc cp metadata_backup.sql.enc minio/es-backups/metadata/
  ```

- [ ] k8s/addons/backup/cronjob.yaml
  ```yaml
  apiVersion: batch/v1
  kind: CronJob
  metadata:
    name: es-backup
  spec:
    schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹
    jobTemplate:
      spec:
        template:
          spec:
            containers:
            - name: backup
              image: backup-tools:latest
              command: ["/scripts/backup-es-snapshot.sh"]
  ```

- [ ] docs/ç¾éš¾æ¢å¤æ‰‹å†Œ.md
  ```markdown
  # ç¾éš¾æ¢å¤æ‰‹å†Œ

  ## RTO/RPO ç›®æ ‡
  - RTO (Recovery Time Objective): 30 åˆ†é’Ÿ
  - RPO (Recovery Point Objective): 24 å°æ—¶

  ## å®Œæ•´æ¢å¤æµç¨‹
  1. éƒ¨ç½²æ–°çš„ Kubernetes é›†ç¾¤
  2. éƒ¨ç½² Elasticsearch
  3. æ¢å¤å…ƒæ•°æ®æ•°æ®åº“
  4. æ¢å¤ Elasticsearch å¿«ç…§
  5. éªŒè¯æ•°æ®å®Œæ•´æ€§
  6. åˆ‡æ¢æµé‡

  ## æ¼”ç»ƒè®¡åˆ’
  - é¢‘ç‡ï¼šæ¯å­£åº¦ä¸€æ¬¡
  - è®°å½•æ¢å¤æ—¶é—´å’Œé—®é¢˜
  ```
```

**éªŒæ”¶æ ‡å‡†:**
- [ ] è‡ªåŠ¨å¤‡ä»½æ¯å¤©æ‰§è¡Œ
- [ ] å¯ä»¥åœ¨ 30 åˆ†é’Ÿå†…ä»å¤‡ä»½æ¢å¤
- [ ] å¤‡ä»½æ•°æ®ä½¿ç”¨ AES-256 åŠ å¯†
- [ ] æ¢å¤æµç¨‹ç»è¿‡æ¼”ç»ƒéªŒè¯
- [ ] å¤‡ä»½æˆåŠŸ/å¤±è´¥æœ‰é€šçŸ¥æœºåˆ¶

---

### 7. æ—¥å¿—ç»“æ„åŒ–å’ŒæŸ¥è¯¢ä¼˜åŒ– âš ï¸ **éƒ¨åˆ†å®ç°**

**å½“å‰çŠ¶æ€:** Fluentd å·²éƒ¨ç½²ï¼Œä½†ç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—å’ŒæŸ¥è¯¢ç•Œé¢

**éœ€è¦å®ç°çš„å†…å®¹:**

```go
// server/main.go - ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—

- [ ] å¼•å…¥ç»“æ„åŒ–æ—¥å¿—åº“
  ```go
  import (
    "github.com/sirupsen/logrus"
    // æˆ–
    "go.uber.org/zap"
  )

  // ç»Ÿä¸€æ—¥å¿—æ ¼å¼
  log.WithFields(logrus.Fields{
    "timestamp":     time.Now().Format(time.RFC3339),
    "level":         "INFO",
    "service":       "manager",
    "tenant_org_id": tenantOrgID,
    "user":          user,
    "action":        "create_cluster",
    "namespace":     namespace,
    "duration_ms":   duration.Milliseconds(),
    "error":         nil,
  }).Info("Cluster created successfully")
  ```

- [ ] ä¿®æ”¹æ‰€æœ‰æœåŠ¡è¾“å‡ºç»“æ„åŒ–æ—¥å¿—
  - server/ (Go services)
  - Elasticsearch (JSON log format)
  - reporting service

- [ ] Kibana Dashboard é…ç½®
  ```json
  // åˆ›å»ºé¢„å®šä¹‰æŸ¥è¯¢æ¨¡æ¿

  // 1. é”™è¯¯æ—¥å¿—æŸ¥è¯¢
  {
    "query": {
      "bool": {
        "must": [
          {"match": {"level": "ERROR"}},
          {"range": {"timestamp": {"gte": "now-1h"}}}
        ]
      }
    }
  }

  // 2. æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆå»¶è¿Ÿ > 1sï¼‰
  {
    "query": {
      "range": {"duration_ms": {"gte": 1000}}
    }
  }

  // 3. ç§Ÿæˆ·æ“ä½œå®¡è®¡
  {
    "query": {
      "bool": {
        "must": [
          {"match": {"tenant_org_id": "org-001"}},
          {"match": {"action": "create_cluster"}}
        ]
      }
    }
  }
  ```

- [ ] Prometheus å‘Šè­¦è§„åˆ™
  ```yaml
  # k8s/addons/monitoring/prometheus-rules.yaml

  groups:
  - name: es-serverless-alerts
    rules:
    - alert: HighErrorRate
      expr: rate(log_errors_total[5m]) > 0.01  # é”™è¯¯ç‡ > 1%
      annotations:
        summary: "High error rate detected"

    - alert: SlowAPIResponse
      expr: histogram_quantile(0.95, api_request_duration_seconds) > 1
      annotations:
        summary: "API P95 latency > 1s"

    - alert: HighDiskUsage
      expr: disk_usage_percent > 90
      annotations:
        summary: "Disk usage > 90%"
  ```
```

**éªŒæ”¶æ ‡å‡†:**
- [ ] æ‰€æœ‰æœåŠ¡è¾“å‡º JSON æ ¼å¼ç»“æ„åŒ–æ—¥å¿—
- [ ] å¯ä»¥é€šè¿‡ Kibana æŸ¥è¯¢å’Œåˆ†ææ—¥å¿—
- [ ] å‘Šè­¦è§„åˆ™æ­£å¸¸è§¦å‘å¹¶å‘é€é€šçŸ¥
- [ ] æ—¥å¿—ä¿ç•™ç­–ç•¥ï¼šçƒ­æ•°æ® 7 å¤©ï¼Œå†·æ•°æ® 90 å¤©

---

### 8. æ’ä»¶ç‰ˆæœ¬ç®¡ç†å’Œåˆ†å‘ âš ï¸ **éƒ¨åˆ†å®ç°**

**å½“å‰çŠ¶æ€:** æœ‰æ„å»ºè„šæœ¬ä½†ç¼ºå°‘ç‰ˆæœ¬ç®¡ç†å’Œåˆ†å‘æœºåˆ¶

**éœ€è¦å®ç°çš„å†…å®¹:**

```gradle
// es-plugin/build.gradle

- [ ] è®¾ç½®ç‰ˆæœ¬å·
  ```gradle
  version = '1.0.0'

  // è‡ªåŠ¨ä» git tag è·å–ç‰ˆæœ¬
  def getVersionFromGit() {
    def stdout = new ByteArrayOutputStream()
    exec {
      commandLine 'git', 'describe', '--tags', '--always'
      standardOutput = stdout
    }
    return stdout.toString().trim()
  }
  ```

- [ ] CHANGELOG.md
  ```markdown
  # Changelog

  ## [1.0.0] - 2025-01-30
  ### Added
  - IVF algorithm implementation
  - Vector field type support
  - ANN query support

  ### Fixed
  - ...
  ```

- [ ] GitHub Actions CI/CD
  ```yaml
  # .github/workflows/build-plugin.yml

  name: Build ES Plugin
  on:
    push:
      tags:
        - 'v*'

  jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Build plugin
          run: |
            cd es-plugin
            ./gradlew assemble
        - name: Create Release
          uses: actions/create-release@v1
          with:
            tag_name: ${{ github.ref }}
            release_name: Release ${{ github.ref }}
            draft: false
        - name: Upload Plugin
          uses: actions/upload-release-asset@v1
          with:
            asset_path: es-plugin/build/distributions/*.zip
  ```

- [ ] æ’ä»¶å®‰è£…æ–‡æ¡£
  ```markdown
  # ES IVF Plugin Installation

  ## åœ¨çº¿å®‰è£…
  ```bash
  bin/elasticsearch-plugin install \
    https://github.com/your-org/es-ivf-plugin/releases/download/v1.0.0/es-ivf-plugin-1.0.0.zip
  ```

  ## ç¦»çº¿å®‰è£…
  ```bash
  # ä¸‹è½½æ’ä»¶
  wget https://github.com/.../es-ivf-plugin-1.0.0.zip

  # å®‰è£…
  bin/elasticsearch-plugin install file:///path/to/es-ivf-plugin-1.0.0.zip
  ```

  ## å…¼å®¹æ€§çŸ©é˜µ
  | Plugin Version | ES Version | JDK Version |
  |----------------|------------|-------------|
  | 1.0.0          | 8.10-8.15  | 17+         |
  ```

- [ ] æ’ä»¶æ›´æ–°æœºåˆ¶
  ```bash
  # æ£€æŸ¥æ–°ç‰ˆæœ¬
  curl https://api.github.com/repos/your-org/es-ivf-plugin/releases/latest

  # å¹³æ»‘å‡çº§ï¼ˆä¸åœæœºï¼‰
  # 1. é€ä¸ªèŠ‚ç‚¹æ»šåŠ¨å‡çº§
  # 2. åœæ­¢èŠ‚ç‚¹
  # 3. æ›´æ–°æ’ä»¶
  # 4. å¯åŠ¨èŠ‚ç‚¹
  # 5. ç­‰å¾…èŠ‚ç‚¹åŠ å…¥é›†ç¾¤
  # 6. é‡å¤ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
  ```
```

**éªŒæ”¶æ ‡å‡†:**
- [ ] æ’ä»¶å¯ä»¥ä¸€é”®å®‰è£…
- [ ] æ”¯æŒ Elasticsearch 8.10 - 8.15
- [ ] GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
- [ ] æœ‰å®Œæ•´çš„ç‰ˆæœ¬æ–‡æ¡£

---

## ğŸŸ¡ é‡è¦ä½†éç´§æ€¥é¡¹

### 9. å¢é‡ç´¢å¼•æ›´æ–°ä¼˜åŒ–

**éœ€æ±‚æ¥æº:** ã€Šè¯´æ˜.mdã€‹3.2.2 è¦æ±‚æ”¯æŒ"ç´¢å¼•æ›´æ–°ï¼ˆå¢é‡ï¼‰"

```java
// es-plugin/src/main/java/com/es/plugin/vector/ivf/

- [ ] IncrementalIndexUpdater.java
  ```java
  /**
   * å¢é‡æ›´æ–°å‘é‡ç´¢å¼•
   *
   * å½“æ–°å¢å‘é‡æ—¶ï¼š
   * 1. ä¸é‡æ–°è®­ç»ƒæ•´ä¸ª KMeans
   * 2. å°†æ–°å‘é‡åˆ†é…åˆ°æœ€è¿‘çš„èšç±»ç°‡
   * 3. æ›´æ–°å€’æ’åˆ—è¡¨
   *
   * è§¦å‘é‡æ–°è®­ç»ƒçš„æ¡ä»¶ï¼š
   * - æ–°å¢å‘é‡æ•°é‡ > æ€»å‘é‡æ•°é‡çš„ 10%
   * - èšç±»è´¨é‡ä¸‹é™ï¼ˆinertia å¢åŠ  > 20%ï¼‰
   */
  public class IncrementalIndexUpdater {
    public void addVectors(List<float[]> newVectors) {
      // å®ç°é€»è¾‘
    }

    public boolean shouldRetrain() {
      // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è®­ç»ƒ
    }
  }
  ```
```

---

### 10. æŸ¥è¯¢æ‰¹å¤„ç†ä¼˜åŒ–

**éœ€æ±‚æ¥æº:** ã€Šè¯´æ˜.mdã€‹3.2.2 è¦æ±‚"æŸ¥è¯¢åŠ é€Ÿï¼ˆbatchingï¼‰"

```java
// es-plugin/src/main/java/com/es/plugin/vector/ivf/

- [ ] BatchQueryOptimizer.java
  ```java
  /**
   * æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
   *
   * å°†å¤šä¸ªå‘é‡æŸ¥è¯¢åˆå¹¶ä¸ºä¸€æ¬¡è¯·æ±‚
   * å…±äº«èšç±»ä¸­å¿ƒè®¡ç®—ç»“æœ
   */
  public class BatchQueryOptimizer {
    public List<SearchResult> batchSearch(List<float[]> queryVectors, int k) {
      // 1. ä¸€æ¬¡æ€§è®¡ç®—æ‰€æœ‰æŸ¥è¯¢å‘é‡åˆ°èšç±»ä¸­å¿ƒçš„è·ç¦»
      // 2. åˆå¹¶éœ€è¦æœç´¢çš„ç°‡ï¼ˆå»é‡ï¼‰
      // 3. æ‰¹é‡æ£€ç´¢å€™é€‰å‘é‡
      // 4. åˆ†åˆ«è®¡ç®—æ¯ä¸ªæŸ¥è¯¢çš„ Top-K
      return results;
    }
  }
  ```
```

---

## æ€»ç»“

æœ¬æ¸…å•è¡¥å……äº†ä»¥ä¸‹å…³é”®é—æ¼é¡¹ï¼š

### ğŸ”´ å¿…é¡»ç«‹å³å®ç°ï¼ˆå½±å“ç³»ç»Ÿå¯ç”¨æ€§æˆ–å®‰å…¨æ€§ï¼‰
1. **Elasticsearch Security å¯ç”¨** - ä¸¥é‡å®‰å…¨æ¼æ´
2. **UI ç›‘æ§é¡µé¢** - è¯´æ˜.md æ˜ç¡®è¦æ±‚
3. **TSNE å‘é‡å¯è§†åŒ–** - è¯´æ˜.md æ˜ç¡®è¦æ±‚

### ğŸŸ¡ é‡è¦ä½†å¯å»¶åï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
4. å‘é‡æ‰¹é‡å¯¼å…¥å·¥å…·
5. é…é¢ç®¡ç†å¼ºåˆ¶æ‰§è¡Œ
6. æ•°æ®å¤‡ä»½è‡ªåŠ¨åŒ–
7. æ—¥å¿—ç»“æ„åŒ–

### ğŸŸ¢ ä¼˜åŒ–é¡¹ï¼ˆæå‡ç³»ç»Ÿè´¨é‡ï¼‰
8. æ’ä»¶ç‰ˆæœ¬ç®¡ç†
9. å¢é‡ç´¢å¼•æ›´æ–°
10. æŸ¥è¯¢æ‰¹å¤„ç†ä¼˜åŒ–

**å»ºè®®ä¼˜å…ˆçº§:**
1. å…ˆä¿®å¤ Elasticsearch Security æ¼æ´ï¼ˆP0ï¼‰
2. å®ç° IVF æ ¸å¿ƒç®—æ³•ï¼ˆP0ï¼‰
3. è¡¥å…… UI ç›‘æ§å’Œå¯è§†åŒ–åŠŸèƒ½ï¼ˆP1ï¼‰
4. å®Œå–„å¤‡ä»½å’Œé…é¢ç®¡ç†ï¼ˆP1ï¼‰
5. å…¶ä»–ä¼˜åŒ–é¡¹ï¼ˆP2-P3ï¼‰
